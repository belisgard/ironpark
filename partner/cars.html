<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ - –ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo">B2P –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">–í—ã–π—Ç–∏</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="dashboard.html" class="sidebar__link">Dashboard</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link active">–ê–≤—Ç–æ</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">–í–æ–¥–∏—Ç–µ–ª–∏</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">–®—Ç—Ä–∞—Ñ—ã</a></li>
        <li class="sidebar__item"><a href="service-orders.html" class="sidebar__link">–†–µ–º–æ–Ω—Ç—ã</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">–û—Ç—á—ë—Ç—ã</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
        <h1>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</h1>
        <button class="btn btn--primary" data-open-modal="#addCarModal">+ –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label class="form-label">–°—Ç–∞—Ç—É—Å:</label>
          <select class="form-select" id="statusFilter" style="width: 200px;">
            <option value="">–í—Å–µ</option>
            <option value="–ù–∞ –ª–∏–Ω–∏–∏">–ù–∞ –ª–∏–Ω–∏–∏</option>
            <option value="–°–≤–æ–±–æ–¥–µ–Ω">–°–≤–æ–±–æ–¥–µ–Ω</option>
            <option value="–í —Ä–µ–º–æ–Ω—Ç–µ">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
            <option value="–ü—Ä–æ—Å—Ä–æ—á–∫–∞">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</option>
          </select>
        </div>
        <div class="filter-group">
          <label><input type="checkbox" class="form-checkbox" id="hasFinesFilter"> –ï—Å—Ç—å —à—Ç—Ä–∞—Ñ—ã</label>
        </div>
        <div class="filter-group">
          <label><input type="checkbox" class="form-checkbox" id="overdueFilter"> –ü—Ä–æ—Å—Ä–æ—á–∫–∞</label>
        </div>
        <div class="filter-group">
          <label><input type="checkbox" class="form-checkbox" id="insuranceFilter"> –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ < 10 –¥–Ω–µ–π</label>
        </div>
        <div class="filter-group">
          <label class="form-label">–ü–æ–∏—Å–∫:</label>
          <input type="text" class="form-input" id="searchInput" placeholder="–ì–æ—Å–Ω–æ–º–µ—Ä" style="width: 200px;">
        </div>
      </div>

      <table class="table" id="carsTable">
        <thead>
          <tr>
            <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
            <th>–ú–æ–¥–µ–ª—å</th>
            <th>–°—Ç–∞—Ç—É—Å –¢–°</th>
            <th>–¢–µ–∫—É—â–∏–π –≤–æ–¥–∏—Ç–µ–ª—å</th>
            <th>–ü—Ä–æ–±–µ–≥</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–ö—É—Ä–∞—Ç–æ—Ä</th>
            <th>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</th>
          </tr>
        </thead>
        <tbody id="carsTableBody">
          <!-- Will be populated by JS -->
        </tbody>
      </table>
    </main>
  </div>

  <!-- Add Car Modal -->
  <div class="modal" id="addCarModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</h3>
        <button class="modal__close" data-close-modal="#addCarModal">√ó</button>
      </div>
      <form id="addCarForm" style="padding: 20px 24px;">
        <div class="form-group">
          <label class="form-label">–ì–æ—Å–Ω–æ–º–µ—Ä *</label>
          <input type="text" class="form-input" id="carPlate" required placeholder="–ê123–ë–í777" pattern="[–ê-–Ø0-9]{1,9}">
        </div>
        <div class="form-group">
          <label class="form-label">–ú–∞—Ä–∫–∞ *</label>
          <input type="text" class="form-input" id="carBrand" required placeholder="Toyota">
        </div>
        <div class="form-group">
          <label class="form-label">–ú–æ–¥–µ–ª—å *</label>
          <input type="text" class="form-input" id="carModel" required placeholder="Camry">
        </div>
        <div class="form-group">
          <label class="form-label">VIN –Ω–æ–º–µ—Ä</label>
          <input type="text" class="form-input" id="carVin" placeholder="VIN1234567890ABCDEF" maxlength="17">
        </div>
        <div class="form-group">
          <label class="form-label">–°–¢–°</label>
          <input type="text" class="form-input" id="carSts" placeholder="77–°–¢123456">
        </div>
        <div class="form-group">
          <label class="form-label">–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
          <input type="number" class="form-input" id="carMileage" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select class="form-select" id="carCategory">
            <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
            <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
          <input type="text" class="form-input" id="carCurator" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü.">
        </div>
        <div class="form-group">
          <label class="form-label">–î–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</label>
          <input type="number" class="form-input" id="carInsuranceDays" placeholder="365" min="0">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="submit" class="btn btn--primary" style="flex: 1;">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button type="button" class="btn btn--normal" data-close-modal="#addCarModal">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    function renderCars() {
      const tbody = document.getElementById('carsTableBody');
      const statusFilter = getUrlParameter('status');
      
      let filteredCars = mockData.cars;
      if (statusFilter) {
        filteredCars = filteredCars.filter(car => car.status === statusFilter);
        document.getElementById('statusFilter').value = statusFilter;
      }

      tbody.innerHTML = filteredCars.map(car => `
        <tr onclick="window.location.href='car.html?id=${car.id}'">
          <td>${car.plate}</td>
          <td>${car.brand ? car.brand + ' ' + car.model : car.model}</td>
          <td><span class="badge ${getStatusBadgeClass(car.status)}">${car.status}</span></td>
          <td>${car.currentDriver || '-'}</td>
          <td>${formatNumber(car.mileage)} –∫–º</td>
          <td>${car.category}</td>
          <td>${car.curator}</td>
          <td>
            ${car.hasFines ? '<span class="badge badge--warning" title="–ï—Å—Ç—å —à—Ç—Ä–∞—Ñ—ã">‚ö†</span>' : ''}
            ${car.hasDebt ? '<span class="badge badge--danger" title="–ï—Å—Ç—å –¥–æ–ª–≥">‚ÇΩ</span>' : ''}
            ${car.insuranceExpiringDays <= 10 ? '<span class="badge badge--warning" title="–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç">üìã</span>' : ''}
          </td>
        </tr>
      `).join('');
    }

    function applyFilters() {
      const status = document.getElementById('statusFilter').value;
      const hasFines = document.getElementById('hasFinesFilter').checked;
      const overdue = document.getElementById('overdueFilter').checked;
      const insurance = document.getElementById('insuranceFilter').checked;
      const search = document.getElementById('searchInput').value.toLowerCase();

      filterTable('#carsTable', (row) => {
        const cells = row.cells;
        if (!cells || cells.length === 0) return false;

        if (status && cells[2].textContent.trim() !== status) return false;
        if (hasFines && !cells[7].textContent.includes('‚ö†')) return false;
        if (overdue && cells[2].textContent.trim() !== '–ü—Ä–æ—Å—Ä–æ—á–∫–∞') return false;
        if (insurance && !cells[7].textContent.includes('üìã')) return false;
        if (search && !cells[0].textContent.toLowerCase().includes(search)) return false;

        return true;
      });
    }

    function addCar(carData) {
      const newId = Math.max(...mockData.cars.map(c => c.id), 0) + 1;
      const newCar = {
        id: newId,
        plate: carData.plate,
        brand: carData.brand,
        model: carData.model,
        vin: carData.vin || null,
        sts: carData.sts || null,
        status: '–°–≤–æ–±–æ–¥–µ–Ω', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        currentDriver: null,
        mileage: parseInt(carData.mileage) || 0,
        category: carData.category || '–≠–∫–æ–Ω–æ–º',
        curator: carData.curator || '',
        hasFines: false,
        insuranceExpiringDays: parseInt(carData.insuranceDays) || 365,
        hasDebt: false
      };
      mockData.cars.push(newCar);
      renderCars();
    }

    // Form submission
    document.getElementById('addCarForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = {
        plate: document.getElementById('carPlate').value.trim(),
        brand: document.getElementById('carBrand').value.trim(),
        model: document.getElementById('carModel').value.trim(),
        vin: document.getElementById('carVin').value.trim(),
        sts: document.getElementById('carSts').value.trim(),
        mileage: document.getElementById('carMileage').value,
        category: document.getElementById('carCategory').value,
        curator: document.getElementById('carCurator').value.trim(),
        insuranceDays: document.getElementById('carInsuranceDays').value
      };
      
      addCar(formData);
      document.getElementById('addCarModal').classList.remove('active');
      document.getElementById('addCarForm').reset();
    });

    // Initialize modal
    initModal('#addCarModal', '[data-open-modal="#addCarModal"]', '[data-close-modal="#addCarModal"]');

    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('hasFinesFilter').addEventListener('change', applyFilters);
    document.getElementById('overdueFilter').addEventListener('change', applyFilters);
    document.getElementById('insuranceFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    renderCars();
  </script>
</body>
</html>
