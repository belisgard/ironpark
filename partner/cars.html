<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Автомобили - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    .sort-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
      padding: 0;
      font: inherit;
      font-weight: 600;
      color: inherit;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link active">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Автомобили</h1>
        <button class="btn btn--primary" data-open-modal="#addCarModal">+ Добавить автомобиль</button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label class="form-label">Статус:</label>
          <select class="form-select" id="statusFilter" style="width: 200px;">
            <option value="">Все</option>
            <option value="На линии">На линии</option>
            <option value="Забронировано">Забронировано</option>
            <option value="Свободна">Свободна</option>
            <option value="В ремонте">В ремонте</option>
            <option value="Архив">Архив</option>
          </select>
        </div>
        <div class="filter-group">
          <label><input type="checkbox" class="form-checkbox" id="hasFinesFilter"> Есть штрафы</label>
        </div>
        <div class="filter-group">
          <label class="form-label">Колонна:</label>
          <select class="form-select" id="columnFilter" style="width: 280px;">
            <option value="">Все</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Страховка менее 10 дней:</label>
          <select class="form-select" id="insuranceFilter" style="width: 140px;">
            <option value="">Все</option>
            <option value="yes">Да</option>
            <option value="no">Нет</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Поиск:</label>
          <input type="text" class="form-input" id="searchInput" placeholder="Госномер" style="width: 200px;">
        </div>
      </div>

      <table class="table" id="carsTable">
        <thead>
          <tr>
            <th>Госномер</th>
            <th>Номер договора</th>
            <th>Модель</th>
            <th>Статус ТС</th>
            <th>Текущий водитель</th>
            <th>
              <button type="button" class="sort-button" data-sort-key="mileage">
                Пробег
                <span data-sort-indicator="mileage">↕</span>
              </button>
            </th>
            <th>Категория</th>
            <th>Окончание брони</th>
            <th>
              <button type="button" class="sort-button" data-sort-key="lastMaintenance">
                Последнее ТО
                <span data-sort-indicator="lastMaintenance">↕</span>
              </button>
            </th>
          </tr>
        </thead>
        <tbody id="carsTableBody">
          <!-- Will be populated by JS -->
        </tbody>
      </table>
    </main>
  </div>

  <!-- Add Car Modal -->
  <div class="modal" id="addCarModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">Добавить автомобиль</h3>
        <button class="modal__close" data-close-modal="#addCarModal">×</button>
      </div>
      <div class="modal__body">
        <form id="addCarForm">
        <div class="form-group">
          <label class="form-label">Госномер *</label>
          <input type="text" class="form-input" id="carPlate" required placeholder="А123БВ777" pattern="[А-Я0-9]{1,9}">
        </div>
        <div class="form-group">
          <label class="form-label">Марка *</label>
          <select class="form-select" id="carBrand" required>
            <option value="">Выберите марку</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Модель *</label>
          <select class="form-select" id="carModel" required disabled>
            <option value="">Выберите модель</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">VIN номер</label>
          <input type="text" class="form-input" id="carVin" placeholder="VIN1234567890ABCDEF" maxlength="17">
        </div>
        <div class="form-group">
          <label class="form-label">СТС</label>
          <input type="text" class="form-input" id="carSts" placeholder="77СТ123456">
        </div>
        <div class="form-group">
          <label class="form-label">Пробег (км)</label>
          <input type="number" class="form-input" id="carMileage" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Категория</label>
          <select class="form-select" id="carCategory">
            <option value="Эконом">Эконом</option>
            <option value="Комфорт">Комфорт</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Адрес колонны</label>
          <select class="form-select" id="carColumnAddress">
            <option value="">Выберите колонну</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; margin-top: var(--g-spacing-xl); padding-top: var(--g-spacing-lg); border-top: 1px solid var(--g-color-line-generic);">
          <button type="submit" class="btn btn--primary" style="flex: 1;">Добавить</button>
          <button type="button" class="btn btn--normal" data-close-modal="#addCarModal">Отмена</button>
        </div>
      </form>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    const sortState = {
      key: null,
      direction: 'asc'
    };
    const COLUMN_ADDRESS_DIRECTORY = [
      'г. Москва, 2-я Магистральная ул., д. 18, колонна 1',
      'г. Москва, ул. Рябиновая, д. 44, колонна 2',
      'г. Москва, Варшавское ш., д. 170Г, колонна 3',
      'г. Москва, Каширское ш., д. 61, колонна 4',
      'г. Москва, Алтуфьевское ш., д. 31Б, колонна 5',
      'г. Москва, ул. Подольских Курсантов, д. 24А, колонна 6'
    ];

    function isInsuranceExpiring(car) {
      return Number(car.insuranceExpiringDays || 0) <= 10;
    }

    function ensureCarColumnAddresses() {
      mockData.cars.forEach((car, index) => {
        if (!car.columnAddress) {
          car.columnAddress = COLUMN_ADDRESS_DIRECTORY[index % COLUMN_ADDRESS_DIRECTORY.length];
        }
      });
    }

    function getContractsByCarPlate(plate) {
      return (mockData.rentContracts || [])
        .filter(contract => contract.vehiclePlate === plate)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    function getContractLinksHtml(plate) {
      const contracts = getContractsByCarPlate(plate);
      if (contracts.length === 0) return '-';

      return contracts.map(contract => (
        `<a href="contract.html?id=${contract.id}" onclick="event.stopPropagation();">${contract.number}</a>`
      )).join('<br>');
    }

    function getLastMaintenanceDate(car) {
      const maintenanceTimestamp = getLastMaintenanceTimestamp(car);
      if (!maintenanceTimestamp) return '-';
      const latestDate = new Date(maintenanceTimestamp);
      return formatDate(latestDate.toISOString().split('T')[0]);
    }

    function getLastMaintenanceTimestamp(car) {
      const inspectionDates = (mockData.inspections || [])
        .filter(inspection => inspection.plate === car.plate && inspection.type === 'Плановый')
        .map(inspection => new Date(inspection.date))
        .filter(date => !Number.isNaN(date.getTime()));

      const eventDates = (mockData.events || [])
        .filter(event => event.carId === car.id && event.type === 'Технический осмотр')
        .map(event => new Date(event.date))
        .filter(date => !Number.isNaN(date.getTime()));

      const cardDate = car.techInspectionIssueDate ? new Date(car.techInspectionIssueDate) : null;
      const allDates = [
        ...inspectionDates,
        ...eventDates,
        ...(cardDate && !Number.isNaN(cardDate.getTime()) ? [cardDate] : [])
      ];

      if (allDates.length === 0) return 0;
      return allDates.sort((a, b) => b - a)[0].getTime();
    }

    function populateColumnFilterOptions() {
      const columnFilter = document.getElementById('columnFilter');
      if (!columnFilter) return;

      const uniqueColumns = [...new Set([
        ...COLUMN_ADDRESS_DIRECTORY,
        ...mockData.cars.map(car => car.columnAddress).filter(Boolean)
      ])].sort((a, b) => a.localeCompare(b, 'ru'));

      columnFilter.innerHTML = '<option value="">Все</option>';
      uniqueColumns.forEach((columnAddress) => {
        const option = document.createElement('option');
        option.value = columnAddress;
        option.textContent = columnAddress;
        columnFilter.appendChild(option);
      });
    }

    function populateColumnDirectoryOptions() {
      const columnAddressSelect = document.getElementById('carColumnAddress');
      if (!columnAddressSelect) return;

      columnAddressSelect.innerHTML = '<option value="">Выберите колонну</option>';
      COLUMN_ADDRESS_DIRECTORY.forEach((columnAddress) => {
        const option = document.createElement('option');
        option.value = columnAddress;
        option.textContent = columnAddress;
        columnAddressSelect.appendChild(option);
      });
    }

    function populateCarBrandOptions() {
      const brandSelect = document.getElementById('carBrand');
      const uniqueBrands = [...new Set(mockData.cars.map(car => car.brand).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru'));

      brandSelect.innerHTML = '<option value="">Выберите марку</option>';
      uniqueBrands.forEach((brand) => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });
    }

    function populateCarModelOptions(brand) {
      const modelSelect = document.getElementById('carModel');
      modelSelect.innerHTML = '<option value="">Выберите модель</option>';

      if (!brand) {
        modelSelect.disabled = true;
        return;
      }

      const uniqueModels = [...new Set(
        mockData.cars
          .filter(car => car.brand === brand)
          .map(car => car.model)
          .filter(Boolean)
      )].sort((a, b) => a.localeCompare(b, 'ru'));

      uniqueModels.forEach((model) => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
      });
      modelSelect.disabled = false;
    }

    function getFilteredCars() {
      const status = document.getElementById('statusFilter').value;
      const hasFines = document.getElementById('hasFinesFilter').checked;
      const columnAddress = document.getElementById('columnFilter').value;
      const insurance = document.getElementById('insuranceFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      return mockData.cars.filter((car) => {
        const modelName = `${car.brand || ''} ${car.model || ''}`.trim().toLowerCase();
        const insuranceExpiring = isInsuranceExpiring(car);

        if (status && car.status !== status) return false;
        if (hasFines && !car.hasFines) return false;
        if (columnAddress && car.columnAddress !== columnAddress) return false;
        if (insurance === 'yes' && !insuranceExpiring) return false;
        if (insurance === 'no' && insuranceExpiring) return false;
        if (search && !car.plate.toLowerCase().includes(search) && !modelName.includes(search)) return false;
        return true;
      });
    }

    function getSortedCars(cars) {
      if (!sortState.key) return cars;
      const directionFactor = sortState.direction === 'asc' ? 1 : -1;

      return [...cars].sort((a, b) => {
        let aValue = 0;
        let bValue = 0;

        if (sortState.key === 'mileage') {
          aValue = Number(a.mileage || 0);
          bValue = Number(b.mileage || 0);
        } else if (sortState.key === 'lastMaintenance') {
          aValue = getLastMaintenanceTimestamp(a);
          bValue = getLastMaintenanceTimestamp(b);
        }

        if (aValue === bValue) return 0;
        return aValue > bValue ? directionFactor : -directionFactor;
      });
    }

    function updateSortIndicators() {
      document.querySelectorAll('[data-sort-indicator]').forEach((indicator) => {
        const key = indicator.dataset.sortIndicator;
        if (sortState.key !== key) {
          indicator.textContent = '↕';
          return;
        }
        indicator.textContent = sortState.direction === 'asc' ? '↑' : '↓';
      });
    }

    function renderCars() {
      const tbody = document.getElementById('carsTableBody');
      const filteredCars = getSortedCars(getFilteredCars());

      if (filteredCars.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--g-color-text-secondary);">Автомобили не найдены</td></tr>';
        updateSortIndicators();
        return;
      }

      tbody.innerHTML = filteredCars.map(car => `
        <tr onclick="window.location.href='car.html?id=${car.id}'">
          <td>${car.plate}</td>
          <td>${getContractLinksHtml(car.plate)}</td>
          <td>${car.brand ? car.brand + ' ' + car.model : car.model}</td>
          <td><span class="badge ${getStatusBadgeClass(car.status)}">${car.status}</span></td>
          <td>${car.currentDriver || '-'}</td>
          <td>${formatNumber(car.mileage)} км</td>
          <td>${car.category || '-'}</td>
          <td>${car.bookingEndAt ? formatDateTime(car.bookingEndAt) : '-'}</td>
          <td>${getLastMaintenanceDate(car)}</td>
        </tr>
      `).join('');

      updateSortIndicators();
    }

    function applyFilters() {
      renderCars();
    }

    function applyInitialFiltersFromUrl() {
      const statusFilter = getUrlParameter('status');
      const insuranceFilter = getUrlParameter('insurance');

      if (statusFilter) {
        if (statusFilter === 'Свободен') {
          document.getElementById('statusFilter').value = 'Свободна';
        } else {
          document.getElementById('statusFilter').value = statusFilter;
        }
      }
      if (insuranceFilter === 'expiring') {
        document.getElementById('insuranceFilter').value = 'yes';
      }
    }

    function addCar(carData) {
      const newId = Math.max(...mockData.cars.map(c => c.id), 0) + 1;
      const newCar = {
        id: newId,
        plate: carData.plate,
        brand: carData.brand,
        model: carData.model,
        vin: carData.vin || null,
        sts: carData.sts || null,
        status: 'Свободна',
        currentDriver: null,
        mileage: parseInt(carData.mileage) || 0,
        category: carData.category || 'Эконом',
        hasFines: false,
        insuranceExpiringDays: 365,
        hasDebt: false,
        isOverdue: false,
        bookingEndAt: null,
        columnAddress: carData.columnAddress || null
      };
      mockData.cars.push(newCar);
      populateColumnFilterOptions();
      populateCarBrandOptions();
      renderCars();
    }

    // Form submission
    document.getElementById('addCarForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = {
        plate: document.getElementById('carPlate').value.trim(),
        brand: document.getElementById('carBrand').value.trim(),
        model: document.getElementById('carModel').value.trim(),
        vin: document.getElementById('carVin').value.trim(),
        sts: document.getElementById('carSts').value.trim(),
        mileage: document.getElementById('carMileage').value,
        category: document.getElementById('carCategory').value,
        columnAddress: document.getElementById('carColumnAddress').value
      };
      
      addCar(formData);
      document.getElementById('addCarModal').classList.remove('active');
      document.getElementById('addCarForm').reset();
      document.getElementById('carModel').innerHTML = '<option value="">Выберите модель</option>';
      document.getElementById('carModel').disabled = true;
    });

    // Initialize modal
    initModal('#addCarModal', '[data-open-modal="#addCarModal"]', '[data-close-modal="#addCarModal"]');

    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('hasFinesFilter').addEventListener('change', applyFilters);
    document.getElementById('columnFilter').addEventListener('change', applyFilters);
    document.getElementById('insuranceFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('carBrand').addEventListener('change', (event) => {
      populateCarModelOptions(event.target.value);
    });

    document.querySelectorAll('[data-sort-key]').forEach((button) => {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const key = button.dataset.sortKey;
        if (sortState.key === key) {
          sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.direction = 'asc';
        }
        renderCars();
      });
    });

    ensureCarColumnAddresses();
    populateColumnDirectoryOptions();
    populateColumnFilterOptions();
    populateCarBrandOptions();
    applyInitialFiltersFromUrl();
    renderCars();
  </script>
</body>
</html>
