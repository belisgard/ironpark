<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Штрафы - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link active">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Штрафы</h1>
        <button class="btn btn--primary" onclick="openRegisterModal()">Сгенерировать реестр</button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label class="form-label">Статус штрафа:</label>
          <select class="form-select" id="statusFilter" style="width: 200px;">
            <option value="">Все</option>
            <option value="Новый">Новый</option>
            <option value="Оплачен">Оплачен</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Статус списания:</label>
          <select class="form-select" id="writeOffStatusFilter" style="width: 220px;">
            <option value="">Все</option>
            <option value="Сумма списана">Сумма списана</option>
            <option value="Сумма не списана">Сумма не списана</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Номер постановления:</label>
          <input type="text" class="form-input" id="resolutionSearch" placeholder="Поиск по номеру" style="width: 220px;">
        </div>
        <div class="filter-group">
          <label class="form-label">Водитель:</label>
          <input type="text" class="form-input" id="driverSearch" placeholder="Поиск по ФИО" style="width: 220px;">
        </div>
        <div class="filter-group">
          <label class="form-label">Период:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="date" class="form-input" id="dateFrom" style="width: 150px;">
            <span style="color: var(--g-color-text-secondary);">—</span>
            <input type="date" class="form-input" id="dateTo" style="width: 150px;">
          </div>
        </div>
      </div>

      <table class="table" id="finesTable">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Номер постановления</th>
            <th>Авто</th>
            <th>Водитель</th>
            <th>Сумма</th>
            <th>Статус штрафа</th>
            <th>Статус списания</th>
            <th>Дата и время списания</th>
            <th>Действие</th>
          </tr>
        </thead>
        <tbody id="finesTableBody"></tbody>
      </table>
    </main>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    function normalizeFineStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      return normalized === 'оплачен' ? 'Оплачен' : 'Новый';
    }

    function getFineWriteOffStatus(fine) {
      return normalizeFineStatus(fine.status) === 'Оплачен' ? 'Сумма списана' : 'Сумма не списана';
    }

    function getFineWriteOffDateTime(fine) {
      if (fine.writeOffDateTime) return formatDateTime(fine.writeOffDateTime);
      if (fine.paidDate) return formatDateTime(`${fine.paidDate}T00:00:00`);
      return '-';
    }

    function getFineResolutionNumber(fine) {
      const providedNumber = (fine.resolutionNumber || '').toString().replace(/\D/g, '');
      if (providedNumber) return providedNumber;
      const datePart = (fine.date || '').toString().replace(/\D/g, '');
      return `${datePart}${String(fine.id).padStart(3, '0')}`;
    }

    function getCarLinkByPlate(plate) {
      const normalizedPlate = (plate || '').toString().trim().toLowerCase();
      const car = mockData.cars.find((item) => (item.plate || '').toString().trim().toLowerCase() === normalizedPlate);
      if (!car) return plate || '-';
      return `<a href="car.html?id=${car.id}" onclick="event.stopPropagation();">${plate}</a>`;
    }

    function renderFines() {
      const statusFilter = document.getElementById('statusFilter')?.value || '';
      const writeOffStatusFilter = document.getElementById('writeOffStatusFilter')?.value || '';
      const resolutionSearch = (document.getElementById('resolutionSearch')?.value || '').replace(/\D/g, '');
      const driverSearch = (document.getElementById('driverSearch')?.value || '').trim().toLowerCase();
      const dateFrom = document.getElementById('dateFrom')?.value || '';
      const dateTo = document.getElementById('dateTo')?.value || '';
      const tbody = document.getElementById('finesTableBody');

      const filteredFines = mockData.fines.filter((fine) => {
        const fineStatus = normalizeFineStatus(fine.status);
        const writeOffStatus = getFineWriteOffStatus(fine);
        const resolutionNumber = getFineResolutionNumber(fine);

        if (statusFilter && fineStatus !== statusFilter) return false;
        if (writeOffStatusFilter && writeOffStatus !== writeOffStatusFilter) return false;
        if (resolutionSearch && !resolutionNumber.includes(resolutionSearch)) return false;
        if (driverSearch && !(fine.driverName || '').toLowerCase().includes(driverSearch)) return false;

        if (dateFrom || dateTo) {
          const rowDateObj = new Date(fine.date);
          if (dateFrom && rowDateObj < new Date(dateFrom)) return false;
          if (dateTo) {
            const dateToObj = new Date(dateTo);
            dateToObj.setHours(23, 59, 59, 999);
            if (rowDateObj > dateToObj) return false;
          }
        }

        return true;
      });

      tbody.innerHTML = filteredFines.length > 0
        ? filteredFines.map(fine => {
        const fineStatus = normalizeFineStatus(fine.status);
        const writeOffStatus = getFineWriteOffStatus(fine);
        const writeOffStatusClass = writeOffStatus === 'Сумма списана' ? 'badge--success' : 'badge--neutral';
        const resolutionNumber = getFineResolutionNumber(fine);
        const canGeneratePP = fineStatus === 'Новый';
        return `
        <tr data-fine-id="${fine.id}" data-fine-date="${fine.date}" onclick="window.location.href='fine.html?id=${fine.id}'" style="cursor: pointer;">
          <td onclick="window.location.href='fine.html?id=${fine.id}'" style="cursor: pointer;">${formatDate(fine.date)}</td>
          <td>${resolutionNumber}</td>
          <td>${getCarLinkByPlate(fine.plate)}</td>
          <td onclick="window.location.href='fine.html?id=${fine.id}'" style="cursor: pointer;">${fine.driverName}</td>
          <td onclick="window.location.href='fine.html?id=${fine.id}'" style="cursor: pointer;">${formatCurrency(fine.amount)}</td>
          <td onclick="window.location.href='fine.html?id=${fine.id}'" style="cursor: pointer;"><span class="badge ${getStatusBadgeClass(fineStatus)}">${fineStatus}</span></td>
          <td><span class="badge ${writeOffStatusClass}">${writeOffStatus}</span></td>
          <td>${getFineWriteOffDateTime(fine)}</td>
          <td style="cursor: default;" onclick="event.stopPropagation();">
            ${canGeneratePP ? `<button class="btn btn--normal" onclick="generatePP(${fine.id})" style="white-space: nowrap;">Сгенерировать ПП</button>` : '-'}
          </td>
        </tr>
      `;
      }).join('')
        : '<tr><td colspan="9" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';
    }

    document.getElementById('statusFilter')?.addEventListener('change', renderFines);
    document.getElementById('writeOffStatusFilter')?.addEventListener('change', renderFines);
    document.getElementById('resolutionSearch')?.addEventListener('input', renderFines);
    document.getElementById('driverSearch')?.addEventListener('input', renderFines);
    document.getElementById('dateFrom')?.addEventListener('change', renderFines);
    document.getElementById('dateTo')?.addEventListener('change', renderFines);

    // Generate PP function
    window.generatePP = function(fineId) {
      const fine = mockData.fines.find(f => f.id === fineId);
      if (!fine) {
        alert('Штраф не найден');
        return;
      }
      alert(`Генерация ПП для штрафа #${fineId}\nДата: ${formatDate(fine.date)}\nАвто: ${fine.plate}\nВодитель: ${fine.driverName}\nСумма: ${formatCurrency(fine.amount)}`);
      // Здесь можно добавить реальную логику генерации ПП
    };

    // Register modal functions
    window.openRegisterModal = function() {
      document.getElementById('registerModal').classList.add('active');
    };

    window.closeRegisterModal = function() {
      document.getElementById('registerModal').classList.remove('active');
    };

    window.generateRegister = function() {
      const dateFrom = document.getElementById('registerDateFrom').value;
      const dateTo = document.getElementById('registerDateTo').value;
      
      if (!dateFrom || !dateTo) {
        alert('Пожалуйста, выберите период');
        return;
      }

      if (new Date(dateFrom) > new Date(dateTo)) {
        alert('Дата начала не может быть позже даты окончания');
        return;
      }

      alert(`Генерация реестра штрафов\nПериод: с ${dateFrom} по ${dateTo}`);
      // Здесь можно добавить реальную логику генерации реестра
      closeRegisterModal();
    };

    // Close modal on backdrop click
    document.getElementById('registerModal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('registerModal')) {
        closeRegisterModal();
      }
    });

    renderFines();
  </script>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">Сгенерировать реестр</h3>
        <button class="modal__close" onclick="closeRegisterModal()">×</button>
      </div>
      <div class="modal__body">
        <div class="form-group">
          <label class="form-label">Период</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="date" class="form-input" id="registerDateFrom" style="width: 150px;">
            <span style="color: var(--g-color-text-secondary);">—</span>
            <input type="date" class="form-input" id="registerDateTo" style="width: 150px;">
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
          <button type="button" class="btn btn--normal" onclick="closeRegisterModal()">Отмена</button>
          <button type="button" class="btn btn--action" onclick="generateRegister()">Сгенерировать</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
