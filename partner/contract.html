<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã - –ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    @media print {
      .header,
      .sidebar,
      .main-layout > main > div:first-child,
      .main-layout > main > div:last-child,
      .btn,
      #contractScan {
        display: none !important;
      }
      .main-layout {
        margin: 0;
        padding: 20px;
      }
      .main-content {
        margin: 0;
        padding: 0;
      }
      .card {
        border: none;
        box-shadow: none;
        page-break-inside: avoid;
      }
      h1 {
        font-size: 24pt;
        margin-bottom: 16pt;
      }
      h2, h3 {
        font-size: 18pt;
        margin-top: 16pt;
        margin-bottom: 12pt;
      }
      body {
        font-size: 12pt;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">–í—ã–π—Ç–∏</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link active">–î–æ–≥–æ–≤–æ—Ä–∞</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">–ê–≤—Ç–æ</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">–í–æ–¥–∏—Ç–µ–ª–∏</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">–®—Ç—Ä–∞—Ñ—ã</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">–†–µ–º–æ–Ω—Ç—ã</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">–û—Ç—á—ë—Ç—ã</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <a href="contracts.html" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

      <div id="contractHeader" style="margin-bottom: 32px;"></div>

      <div id="contractStatusList" style="margin-bottom: 24px;"></div>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
        <button class="btn btn--normal" id="printContractBtn">–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
        <label for="uploadScanInput" class="btn btn--normal" style="cursor: pointer; margin: 0;">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä
          <input type="file" id="uploadScanInput" accept="image/*,.pdf" style="display: none;">
        </label>
        <a id="downloadContractBtn" class="btn btn--normal" href="#" download style="display: none; text-decoration: none;">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –¥–æ–≥–æ–≤–æ—Ä–∞</a>
        <button class="btn btn--action" data-open-modal="#editContractModal">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>

      <div class="card" id="contractInfo" style="margin-bottom: 32px;"></div>

      <div class="card" id="contractScan" style="margin-bottom: 32px; display: none;">
        <h3>–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä</h3>
        <div id="scanPreview" style="margin-bottom: var(--g-spacing-lg);">
          <img id="scanImage" src="" alt="–°–∫–∞–Ω –¥–æ–≥–æ–≤–æ—Ä–∞" style="max-width: 100%; max-height: 500px; border: 1px solid var(--g-color-line-generic); border-radius: var(--g-border-radius-md); display: none;">
          <iframe id="scanPdf" src="" style="width: 100%; height: 600px; border: 1px solid var(--g-color-line-generic); border-radius: var(--g-border-radius-md); display: none;"></iframe>
          <div id="scanInfo" style="padding: 16px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md); display: none;">
            <a id="scanDownloadLink" href="" target="_blank" style="color: var(--g-color-text-link); text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
              <span>üìÑ</span>
              <span>–û—Ç–∫—Ä—ã—Ç—å —Å–∫–∞–Ω –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ</span>
            </a>
          </div>
        </div>
        <button class="btn btn--normal" id="removeScanBtn" style="display: none;">–£–¥–∞–ª–∏—Ç—å —Å–∫–∞–Ω</button>
      </div>
    </main>
  </div>

  <!-- Edit Contract Modal -->
  <div class="modal" id="editContractModal">
    <div class="modal__content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal__header">
        <h3 class="modal__title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞</h3>
        <button class="modal__close" data-close-modal="#editContractModal">√ó</button>
      </div>
      <div class="modal__body" style="padding: var(--g-spacing-xl);">
        <form id="editContractForm">
          <div style="margin-bottom: 32px;">
            <h4>–î–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">–í–æ–¥–∏—Ç–µ–ª—å *</label>
                <select class="form-input" id="editContractDriver" name="driverId" required>
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</label>
                <input type="text" class="form-input" id="editDriverName" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" class="form-input" id="editDriverPhone" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <input type="text" class="form-input" id="editDriverStatus" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–°–µ—Ä–∏—è/–Ω–æ–º–µ—Ä (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" class="form-input" id="editPassportSeries" placeholder="–°–µ—Ä–∏—è" style="flex: 1;">
                  <input type="text" class="form-input" id="editPassportNumber" placeholder="–ù–æ–º–µ—Ä" style="flex: 1;">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</label>
                <input type="text" class="form-input" id="editPassportCitizenship" placeholder="–†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è">
              </div>
              <div class="form-group">
                <label class="form-label">–ö–µ–º –≤—ã–¥–∞–Ω</label>
                <input type="text" class="form-input" id="editPassportIssuedBy" placeholder="–û–£–§–ú–° –†–æ—Å—Å–∏–∏">
              </div>
              <div class="form-group">
                <label class="form-label">–ü–æ–ª</label>
                <select class="form-select" id="editPassportGender">
                  <option value="–ú—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
                  <option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                <input type="date" class="form-input" id="editPassportIssueDate">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                <input type="date" class="form-input" id="editPassportValidUntil">
              </div>
              <div class="form-group">
                <label class="form-label">–ö–æ–¥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</label>
                <input type="text" class="form-input" id="editPassportDepartmentCode" placeholder="220-001">
              </div>
              <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                <input type="text" class="form-input" id="editPassportRegistrationAddress" placeholder="–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">
              </div>
              <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="date" class="form-input" id="editPassportBirthDate">
              </div>
              <div class="form-group">
                <label class="form-label">–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="text" class="form-input" id="editPassportBirthPlace" placeholder="–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è">
              </div>
            </div>
          </div>

          <div style="margin-bottom: 32px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <h4>–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ *</label>
                <select class="form-input" id="editContractVehicle" name="vehiclePlate" required>
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¢–°</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</label>
                <input type="text" class="form-input" id="editVehicleName" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–ì–æ—Å–Ω–æ–º–µ—Ä</label>
                <input type="text" class="form-input" id="editVehiclePlate" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                <input type="text" class="form-input" id="editVehicleYear" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–ü—Ä–æ–±–µ–≥</label>
                <input type="text" class="form-input" id="editVehicleMileage" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –¢–°</label>
                <input type="text" class="form-input" id="editVehicleStatus" readonly style="background: var(--g-color-base-generic);">
              </div>
            </div>
          </div>

          <div style="margin-bottom: 32px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–≥–æ–≤–æ—Ä–∞</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <input type="text" class="form-input" id="editContractNumber" name="number" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <input type="text" class="form-input" id="editContractDate" readonly style="background: var(--g-color-base-generic);">
              </div>
              <div class="form-group">
                <label class="form-label">–ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è *</label>
                <input type="date" class="form-input" id="editContractStartDate" name="startDate" required>
              </div>
              <div class="form-group">
                <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</label>
                <input type="date" class="form-input" id="editContractEndDate" name="endDate">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –≤ —Å—É—Ç–∫–∏ *</label>
                <input type="number" class="form-input" id="editContractDailyRent" name="dailyRent" required min="0" step="0.01">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –¥–µ–π—Å—Ç–≤–∏—è</label>
                <select class="form-select" id="editContractActionStatus" name="status">
                  <option value="–ù–µ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π">–ù–µ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π</option>
                  <option value="–î–µ–π—Å—Ç–≤—É—é—â–∏–π">–î–µ–π—Å—Ç–≤—É—é—â–∏–π</option>
                  <option value="–ó–∞–∫—Ä—ã—Ç—ã–π">–ó–∞–∫—Ä—ã—Ç—ã–π</option>
                  <option value="–ê–Ω—É–ª–∏—Ä–æ–≤–∞">–ê–Ω—É–ª–∏—Ä–æ–≤–∞</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –¥–æ–≥–æ–≤–æ—Ä–∞ *</label>
                <select class="form-select" id="editContractStatusField" name="contractStatus" required>
                  <option value="–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</option>
                  <option value="–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è">–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è</option>
                  <option value="–ü–æ–¥–ø–∏—Å–∞–Ω">–ü–æ–¥–ø–∏—Å–∞–Ω</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–í—ã–¥–∞—á–∞ *</label>
                <select class="form-select" id="editContractIssuanceStatus" name="issuanceStatus">
                  <option value="–ê–≤—Ç–æ –Ω–µ –≤—ã–¥–∞–Ω–æ">–ê–≤—Ç–æ –Ω–µ –≤—ã–¥–∞–Ω–æ</option>
                  <option value="–ê–≤—Ç–æ –≤—ã–¥–∞–Ω–æ">–ê–≤—Ç–æ –≤—ã–¥–∞–Ω–æ</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–ì—Ä–∞—Ñ–∏–∫ –∞—Ä–µ–Ω–¥—ã</label>
                <select class="form-select" id="editContractSchedule" name="rentSchedule">
                  <option value="6/1">6/1</option>
                  <option value="5/2">5/2</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <select class="form-select" id="editContractType" name="contractType">
                  <option value="–ê—Ä–µ–Ω–¥–∞">–ê—Ä–µ–Ω–¥–∞</option>
                  <option value="–í—ã–∫—É–ø">–í—ã–∫—É–ø</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 12px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <button type="button" class="btn btn--normal" data-close-modal="#editContractModal">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn--action">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    const contractId = getUrlParameter('id');
    const contract = getRentContractById(contractId);

    function normalizeContractStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === '–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∫–∞–Ω –∑–∞–≥—Ä—É–∂–µ–Ω' || normalized === '–ø–æ–¥–ø–∏—Å–∞–Ω') return '–ü–æ–¥–ø–∏—Å–∞–Ω';
      if (normalized === '—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Å–ø–æ—Ä—Ç–∞' || normalized === '—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ' || normalized === '—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è') return '–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è';
      return '–ù–æ–≤—ã–π';
    }

    function normalizeActionStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === '–¥–µ–π—Å—Ç–≤—É—é—â–∏–π') return '–î–µ–π—Å—Ç–≤—É—é—â–∏–π';
      if (normalized === '–∑–∞–∫—Ä—ã—Ç—ã–π' || normalized === '–∑–∞–∫—Ä—ã—Ç') return '–ó–∞–∫—Ä—ã—Ç—ã–π';
      if (normalized === '–∞–Ω—É–ª–∏—Ä–æ–≤–∞' || normalized === '–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞' || normalized === '–∞–Ω—É–ª–∏—Ä–æ–≤–∞–Ω' || normalized === '–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω') return '–ê–Ω—É–ª–∏—Ä–æ–≤–∞';
      if (normalized === '–∏—Å—Ç–µ–∫—à–∏–π' || normalized === '–Ω–µ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π' || normalized === '–Ω–µ–¥–µ–π—Å—Ç–≤—É—é—â–∏–π') return '–ù–µ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π';
      return normalized ? '–ù–µ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π' : '–î–µ–π—Å—Ç–≤—É—é—â–∏–π';
    }

    function normalizeIssuanceStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === '–∞–≤—Ç–æ –≤—ã–¥–∞–Ω–æ') return '–ê–≤—Ç–æ –≤—ã–¥–∞–Ω–æ';
      return '–ê–≤—Ç–æ –Ω–µ –≤—ã–¥–∞–Ω–æ';
    }

    function normalizeRentSchedule(schedule) {
      return schedule === '6/1' ? '6/1' : '5/2';
    }

    function normalizeContractType(contractType) {
      const normalized = (contractType || '').toString().trim().toLowerCase();
      return normalized === '–≤—ã–∫—É–ø' ? '–í—ã–∫—É–ø' : '–ê—Ä–µ–Ω–¥–∞';
    }

    function getActionStatusBadgeClass(status) {
      if (status === '–î–µ–π—Å—Ç–≤—É—é—â–∏–π') return 'badge--success';
      if (status === '–ê–Ω—É–ª–∏—Ä–æ–≤–∞') return 'badge--danger';
      if (status === '–ó–∞–∫—Ä—ã—Ç—ã–π') return 'badge--warning';
      return 'badge--neutral';
    }

    function getContractStatusBadgeClass(status) {
      if (status === '–ü–æ–¥–ø–∏—Å–∞–Ω') return 'badge--success';
      if (status === '–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è') return 'badge--warning';
      return 'badge--info';
    }

    function getIssuanceStatusBadgeClass(status) {
      if (status === '–ê–≤—Ç–æ –≤—ã–¥–∞–Ω–æ') return 'badge--success';
      return 'badge--neutral';
    }

    if (!contract) {
      document.body.innerHTML = '<div class="container"><h1>–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</h1><a href="contracts.html">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a></div>';
    } else {
      contract.contractStatus = normalizeContractStatus(contract.contractStatus);
      contract.status = normalizeActionStatus(contract.status);
      contract.issuanceStatus = normalizeIssuanceStatus(contract.issuanceStatus);
      contract.rentSchedule = normalizeRentSchedule(contract.rentSchedule);
      contract.contractType = normalizeContractType(contract.contractType);

      const driver = getDriverById(contract.driverId);
      const car = mockData.cars.find(c => c.plate === contract.vehiclePlate);

      // Render header
      document.getElementById('contractHeader').innerHTML = `
        <h1>–î–æ–≥–æ–≤–æ—Ä ${contract.number}</h1>
      `;

      // Render contract status list
      const contractStatusList = document.getElementById('contractStatusList');
      if (contractStatusList) {
        contractStatusList.innerHTML = `
          <div class="card">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 24px;">
              <div class="form-group" style="margin: 0;">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <div style="min-height: 24px;"><span class="badge ${getContractStatusBadgeClass(contract.contractStatus)}">${contract.contractStatus}</span></div>
              </div>
              <div class="form-group" style="margin: 0;">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –¥–µ–π—Å—Ç–≤–∏—è</label>
                <div style="min-height: 24px;"><span class="badge ${getActionStatusBadgeClass(contract.status)}">${contract.status}</span></div>
              </div>
              <div class="form-group" style="margin: 0;">
                <label class="form-label">–°—Ç–∞—Ç—É—Å –≤—ã–¥–∞—á–∏</label>
                <div style="min-height: 24px;"><span class="badge ${getIssuanceStatusBadgeClass(contract.issuanceStatus)}">${contract.issuanceStatus}</span></div>
              </div>
            </div>
          </div>
        `;
      }

      // Helper function to calculate days
      function calculateDays(startDate, endDate) {
        if (!startDate || !endDate) return 0;
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      }

      // Helper function to calculate total amount
      function calculateTotalAmount(dailyRent, days) {
        return dailyRent * days;
      }

      // Calculate days and total amount
      const days = calculateDays(contract.startDate, contract.endDate);
      const totalAmount = contract.totalAmount || calculateTotalAmount(contract.dailyRent, days);
      const driverLinkMarkup = contract.driverId
        ? `<a href="driver.html?id=${contract.driverId}" style="color: var(--g-color-text-link); text-decoration: none;">${contract.driverName || '-'}</a>`
        : (contract.driverName || '-');
      const vehicleLinkMarkup = car?.id
        ? `<a href="car.html?id=${car.id}" style="color: var(--g-color-text-link); text-decoration: none;">${contract.vehicleName || '-'}</a>`
        : (contract.vehicleName || '-');
      const vehiclePlateLinkMarkup = car?.id
        ? `<a href="car.html?id=${car.id}" style="color: var(--g-color-text-link); text-decoration: none;">${contract.vehiclePlate || '-'}</a>`
        : (contract.vehiclePlate || '-');

      function getSignedContractLinkMarkup() {
        if (!contract.scan) return '-';
        const fileName = contract.scanFileName || `${contract.number}-signed-contract`;
        return `<a href="${contract.scan}" target="_blank" download="${fileName}" style="color: var(--g-color-text-link); text-decoration: none;">–°–∫–∞—á–∞—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä</a>`;
      }

      // Render contract info
      document.getElementById('contractInfo').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
          <div class="form-group">
            <label class="form-label">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
            <div style="min-height: 24px;">${contract.number}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–î–∞—Ç–∞</label>
            <div style="min-height: 24px;">${formatDateTime(contract.date)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è</label>
            <div style="min-height: 24px;">${formatDate(contract.startDate)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</label>
            <div style="min-height: 24px;">${formatDate(contract.endDate)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –∞—Ä–µ–Ω–¥—É</label>
            <div style="min-height: 24px;">${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –≤ —Å—É—Ç–∫–∏</label>
            <div style="min-height: 24px;">${formatCurrency(contract.dailyRent)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã</label>
            <div style="min-height: 24px; font-weight: 600; color: var(--g-color-text-primary);">${formatCurrency(totalAmount)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ì—Ä–∞—Ñ–∏–∫ –∞—Ä–µ–Ω–¥—ã</label>
            <div style="min-height: 24px;">${contract.rentSchedule}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞</label>
            <div style="min-height: 24px;">${contract.contractType}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä</label>
            <div id="signedContractLinkValue" style="min-height: 24px;">${getSignedContractLinkMarkup()}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–í–æ–¥–∏—Ç–µ–ª—å</label>
            <div style="min-height: 24px;">${driverLinkMarkup}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è</label>
            <div style="min-height: 24px;">${driver?.phone || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ</label>
            <div style="min-height: 24px;">${vehicleLinkMarkup}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ì–æ—Å–Ω–æ–º–µ—Ä</label>
            <div style="min-height: 24px;">${vehiclePlateLinkMarkup}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
            <div style="min-height: 24px;">${car?.year || '-'}</div>
          </div>
          <div class="form-group">
            <label class="form-label">–ü—Ä–æ–±–µ–≥</label>
            <div style="min-height: 24px;">${car?.mileage ? formatNumber(car.mileage).replace(/,/g, ' ') : '-'}</div>
          </div>
        </div>
      `;

      function updateSignedContractLink() {
        const signedContractLinkValue = document.getElementById('signedContractLinkValue');
        if (signedContractLinkValue) {
          signedContractLinkValue.innerHTML = getSignedContractLinkMarkup();
        }
      }

      // Initialize modal
      initModal('#editContractModal', '[data-open-modal="#editContractModal"]', '[data-close-modal="#editContractModal"]');

      // Populate selects
      const driverSelect = document.getElementById('editContractDriver');
      const vehicleSelect = document.getElementById('editContractVehicle');
      
      if (driverSelect) {
        mockData.drivers.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          if (d.id === contract.driverId) option.selected = true;
          driverSelect.appendChild(option);
        });
      }

      if (vehicleSelect) {
        mockData.cars.forEach(c => {
          const option = document.createElement('option');
          option.value = c.plate;
          option.textContent = `${c.brand} ${c.model} (${c.plate})`;
          if (c.plate === contract.vehiclePlate) option.selected = true;
          vehicleSelect.appendChild(option);
        });
      }

      // Populate form fields
      const formatDateForInput = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];
      };

      document.getElementById('editContractNumber').value = contract.number;
      document.getElementById('editContractDate').value = formatDateTime(contract.date);
      document.getElementById('editContractStartDate').value = formatDateForInput(contract.startDate);
      document.getElementById('editContractEndDate').value = formatDateForInput(contract.endDate);
      document.getElementById('editContractDailyRent').value = contract.dailyRent;
      document.getElementById('editContractActionStatus').value = contract.status;
      document.getElementById('editContractStatusField').value = contract.contractStatus;
      document.getElementById('editContractIssuanceStatus').value = contract.issuanceStatus;
      document.getElementById('editContractSchedule').value = contract.rentSchedule;
      document.getElementById('editContractType').value = contract.contractType;

      // Update driver info when driver changes
      function updateDriverInfo() {
        const selectedDriverId = parseInt(driverSelect.value);
        const selectedDriver = getDriverById(selectedDriverId);
        if (selectedDriver) {
          document.getElementById('editDriverName').value = selectedDriver.name;
          document.getElementById('editDriverPhone').value = selectedDriver.phone || '-';
          document.getElementById('editDriverStatus').value = selectedDriver.status || '-';
          document.getElementById('editPassportSeries').value = selectedDriver.passportSeries || '';
          document.getElementById('editPassportNumber').value = selectedDriver.passportNumber || '';
          document.getElementById('editPassportCitizenship').value = selectedDriver.citizenship || '';
          document.getElementById('editPassportIssuedBy').value = selectedDriver.passportIssuedBy || '';
          document.getElementById('editPassportGender').value = selectedDriver.gender || '–ú—É–∂—Å–∫–æ–π';
          document.getElementById('editPassportIssueDate').value = selectedDriver.passportIssueDate || '';
          document.getElementById('editPassportValidUntil').value = selectedDriver.passportValidUntil || '';
          document.getElementById('editPassportDepartmentCode').value = selectedDriver.passportDepartmentCode || '';
          document.getElementById('editPassportRegistrationAddress').value = selectedDriver.registrationAddress || '';
          document.getElementById('editPassportBirthDate').value = selectedDriver.birthDate || '';
          document.getElementById('editPassportBirthPlace').value = selectedDriver.birthPlace || '';
        } else {
          document.getElementById('editDriverName').value = '';
          document.getElementById('editDriverPhone').value = '';
          document.getElementById('editDriverStatus').value = '';
          document.getElementById('editPassportSeries').value = '';
          document.getElementById('editPassportNumber').value = '';
          document.getElementById('editPassportCitizenship').value = '';
          document.getElementById('editPassportIssuedBy').value = '';
          document.getElementById('editPassportGender').value = '–ú—É–∂—Å–∫–æ–π';
          document.getElementById('editPassportIssueDate').value = '';
          document.getElementById('editPassportValidUntil').value = '';
          document.getElementById('editPassportDepartmentCode').value = '';
          document.getElementById('editPassportRegistrationAddress').value = '';
          document.getElementById('editPassportBirthDate').value = '';
          document.getElementById('editPassportBirthPlace').value = '';
        }
      }

      // Update vehicle info when vehicle changes
      function updateVehicleInfo() {
        const selectedPlate = vehicleSelect.value;
        const selectedCar = mockData.cars.find(c => c.plate === selectedPlate);
        if (selectedCar) {
          document.getElementById('editVehicleName').value = `${selectedCar.brand} ${selectedCar.model}`;
          document.getElementById('editVehiclePlate').value = selectedCar.plate;
          document.getElementById('editVehicleYear').value = selectedCar.year || '-';
          document.getElementById('editVehicleMileage').value = selectedCar.mileage ? formatNumber(selectedCar.mileage).replace(/,/g, ' ') : '-';
          document.getElementById('editVehicleStatus').value = selectedCar.status || '-';
        } else {
          document.getElementById('editVehicleName').value = '';
          document.getElementById('editVehiclePlate').value = '';
          document.getElementById('editVehicleYear').value = '';
          document.getElementById('editVehicleMileage').value = '';
          document.getElementById('editVehicleStatus').value = '';
        }
      }

      // Initial populate
      if (driver) {
        updateDriverInfo();
      }
      if (car) {
        updateVehicleInfo();
      }

      // Add event listeners
      driverSelect?.addEventListener('change', updateDriverInfo);
      vehicleSelect?.addEventListener('change', updateVehicleInfo);

      // Print function
      const printBtn = document.getElementById('printContractBtn');
      if (printBtn) {
        printBtn.addEventListener('click', () => {
          window.print();
        });
      }

      // Upload scan function
      const uploadScanInput = document.getElementById('uploadScanInput');
      const contractScanCard = document.getElementById('contractScan');
      const scanImage = document.getElementById('scanImage');
      const scanPdf = document.getElementById('scanPdf');
      const scanInfo = document.getElementById('scanInfo');
      const scanDownloadLink = document.getElementById('scanDownloadLink');
      const downloadContractBtn = document.getElementById('downloadContractBtn');
      const removeScanBtn = document.getElementById('removeScanBtn');

      function displayScan(scanUrl, isPdf = false) {
        if (scanUrl) {
          // Hide all scan preview elements
          scanImage.style.display = 'none';
          scanPdf.style.display = 'none';
          scanInfo.style.display = 'none';

          if (isPdf) {
            // Display PDF
            scanPdf.src = scanUrl;
            scanPdf.style.display = 'block';
            scanDownloadLink.href = scanUrl;
            scanInfo.style.display = 'block';
          } else {
            // Display image
            scanImage.src = scanUrl;
            scanImage.style.display = 'block';
          }

          if (downloadContractBtn) {
            downloadContractBtn.href = scanUrl;
            downloadContractBtn.download = contract.scanFileName || `${contract.number}-signed-contract`;
            downloadContractBtn.style.display = 'inline-flex';
          }

          contractScanCard.style.display = 'block';
          removeScanBtn.style.display = 'inline-block';
          updateSignedContractLink();
        } else {
          contractScanCard.style.display = 'none';
          removeScanBtn.style.display = 'none';
          scanImage.src = '';
          scanPdf.src = '';
          scanImage.style.display = 'none';
          scanPdf.style.display = 'none';
          scanInfo.style.display = 'none';
          if (downloadContractBtn) {
            downloadContractBtn.href = '#';
            downloadContractBtn.style.display = 'none';
          }
          updateSignedContractLink();
        }
      }

      // Load existing scan if available
      if (contract.scan) {
        const isPdf = contract.scanType === 'pdf';
        displayScan(contract.scan, isPdf);
      }

      // Handle file upload
      if (uploadScanInput) {
        uploadScanInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // Check file type
          const isImage = file.type.startsWith('image/');
          const isPdf = file.type === 'application/pdf';

          if (!isImage && !isPdf) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG, GIF) –∏–ª–∏ PDF —Ñ–∞–π–ª');
            return;
          }

          // Check file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 –ú–ë');
            return;
          }

          const reader = new FileReader();
          reader.onload = (event) => {
            const fileUrl = event.target.result;
            
            // Store scan in contract object
            contract.scan = fileUrl;
            contract.scanType = isPdf ? 'pdf' : 'image';
            contract.scanFileName = file.name;
            
            // Display scan
            displayScan(fileUrl, isPdf);
            
            alert('–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
          };
          
          reader.onerror = () => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
          };

          reader.readAsDataURL(file);
        });
      }

      // Handle scan removal
      if (removeScanBtn) {
        removeScanBtn.addEventListener('click', () => {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä?')) {
            contract.scan = null;
            contract.scanType = null;
            contract.scanFileName = null;
            displayScan(null);
            uploadScanInput.value = '';
            alert('–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä —É–¥–∞–ª–µ–Ω');
          }
        });
      }

      // Form submission
      const editForm = document.getElementById('editContractForm');
      if (editForm) {
        editForm.addEventListener('submit', (e) => {
          e.preventDefault();

          const updatedDriverId = parseInt(document.getElementById('editContractDriver').value);
          const updatedVehiclePlate = document.getElementById('editContractVehicle').value;
          const updatedStartDate = document.getElementById('editContractStartDate').value;
          const updatedEndDate = document.getElementById('editContractEndDate').value;
          const updatedDailyRent = parseFloat(document.getElementById('editContractDailyRent').value);
          const updatedActionStatus = document.getElementById('editContractActionStatus').value;
          const updatedContractStatus = document.getElementById('editContractStatusField').value;
          const updatedIssuanceStatus = document.getElementById('editContractIssuanceStatus').value;
          const updatedRentSchedule = document.getElementById('editContractSchedule').value;
          const updatedContractType = document.getElementById('editContractType').value;

          const updatedDriver = getDriverById(updatedDriverId);
          const updatedCar = mockData.cars.find(c => c.plate === updatedVehiclePlate);

          if (!updatedDriver || !updatedCar) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–æ–¥–∏—Ç–µ–ª—å –∏–ª–∏ –¢–°');
            return;
          }

          // Calculate days and total amount
          const updatedDays = updatedEndDate ? calculateDays(updatedStartDate, updatedEndDate) : 0;
          const updatedTotalAmount = calculateTotalAmount(updatedDailyRent, updatedDays);

          // Update contract
          contract.driverId = updatedDriverId;
          contract.driverName = updatedDriver.name;
          contract.vehiclePlate = updatedVehiclePlate;
          contract.vehicleName = `${updatedCar.brand} ${updatedCar.model}`;
          contract.startDate = updatedStartDate;
          contract.endDate = updatedEndDate || null;
          contract.dailyRent = updatedDailyRent;
          contract.totalAmount = updatedTotalAmount;
          contract.status = normalizeActionStatus(updatedActionStatus);
          contract.contractStatus = normalizeContractStatus(updatedContractStatus);
          contract.issuanceStatus = normalizeIssuanceStatus(updatedIssuanceStatus);
          contract.rentSchedule = normalizeRentSchedule(updatedRentSchedule);
          contract.contractType = normalizeContractType(updatedContractType);
          updatedDriver.passportSeries = document.getElementById('editPassportSeries').value;
          updatedDriver.passportNumber = document.getElementById('editPassportNumber').value;
          updatedDriver.citizenship = document.getElementById('editPassportCitizenship').value;
          updatedDriver.passportIssuedBy = document.getElementById('editPassportIssuedBy').value;
          updatedDriver.gender = document.getElementById('editPassportGender').value;
          updatedDriver.passportIssueDate = document.getElementById('editPassportIssueDate').value;
          updatedDriver.passportValidUntil = document.getElementById('editPassportValidUntil').value;
          updatedDriver.passportDepartmentCode = document.getElementById('editPassportDepartmentCode').value;
          updatedDriver.registrationAddress = document.getElementById('editPassportRegistrationAddress').value;
          updatedDriver.birthDate = document.getElementById('editPassportBirthDate').value;
          updatedDriver.birthPlace = document.getElementById('editPassportBirthPlace').value;

          if (updatedDriver.passportSeries && updatedDriver.passportNumber && contract.contractStatus === '–ù–æ–≤—ã–π') {
            contract.contractStatus = '–¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è';
          }

          // Reload the page to show updated data
          location.reload();
        });
      }
    }
  </script>
</body>
</html>
