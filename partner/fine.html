<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карточка штрафа - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link active">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <a href="fines.html" class="back-link">← Назад к списку</a>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
        <button class="btn btn--primary" id="generatePPBtn" onclick="generatePP()" style="display: none;">Сгенерировать ПП</button>
      </div>

      <div class="card" id="fineInfo" style="margin-bottom: 32px;"></div>

      <div class="card" style="margin-top: var(--g-spacing-xl);">
        <h3>Фото/вложения</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
          <div style="width: 100%; height: 150px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md); display: flex; align-items: center; justify-content: center;">
            <span style="color: var(--g-color-text-hint);">Placeholder</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    function normalizeFineStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      return normalized === 'оплачен' ? 'Оплачен' : 'Новый';
    }

    function getFineWriteOffStatus(fine) {
      return normalizeFineStatus(fine.status) === 'Оплачен' ? 'Сумма списана' : 'Сумма не списана';
    }

    function getFineWriteOffDateTime(fine) {
      if (fine.writeOffDateTime) return formatDateTime(fine.writeOffDateTime);
      if (fine.paidDate) return formatDateTime(`${fine.paidDate}T00:00:00`);
      return '-';
    }

    function getFineResolutionNumber(fine) {
      const providedNumber = (fine.resolutionNumber || '').toString().replace(/\D/g, '');
      if (providedNumber) return providedNumber;
      const datePart = (fine.date || '').toString().replace(/\D/g, '');
      return `${datePart}${String(fine.id).padStart(3, '0')}`;
    }

    function getCarLinkByPlate(plate) {
      const normalizedPlate = (plate || '').toString().trim().toLowerCase();
      const car = mockData.cars.find((item) => (item.plate || '').toString().trim().toLowerCase() === normalizedPlate);
      if (!car) return plate || '-';
      return `<a href="car.html?id=${car.id}" style="color: var(--g-color-text-link); text-decoration: none;">${plate}</a>`;
    }

    function getDriverLinkByName(name) {
      const normalizedName = (name || '').toString().trim().toLowerCase();
      const driver = mockData.drivers.find((item) => (item.name || '').toString().trim().toLowerCase() === normalizedName);
      if (!driver) return name || '-';
      return `<a href="driver.html?id=${driver.id}" style="color: var(--g-color-text-link); text-decoration: none;">${name}</a>`;
    }

    const fineId = getUrlParameter('id');
    const fine = getFineById(fineId);

    if (!fine) {
      document.body.innerHTML = '<div class="container"><h1>Штраф не найден</h1><a href="fines.html">Вернуться к списку</a></div>';
    } else {
      const fineStatus = normalizeFineStatus(fine.status);
      const writeOffStatus = getFineWriteOffStatus(fine);
      const writeOffDateTime = getFineWriteOffDateTime(fine);
      const resolutionNumber = getFineResolutionNumber(fine);
      const writeOffStatusClass = writeOffStatus === 'Сумма списана' ? 'badge--success' : 'badge--neutral';

      // Show generate PP button only for "Новый" status in current status model
      const canGeneratePP = fineStatus === 'Новый';
      const generatePPBtn = document.getElementById('generatePPBtn');
      if (generatePPBtn) {
        generatePPBtn.style.display = canGeneratePP ? 'inline-block' : 'none';
      }

      document.getElementById('fineInfo').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px;">
          <div class="form-group">
            <label class="form-label">Дата штрафа</label>
            <div>${formatDate(fine.date)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Номер постановления</label>
            <div>${resolutionNumber}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Авто</label>
            <div>${getCarLinkByPlate(fine.plate)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Водитель</label>
            <div>${getDriverLinkByName(fine.driverName)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Сумма</label>
            <div>${formatCurrency(fine.amount)}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Статус штрафа</label>
            <div><span class="badge ${getStatusBadgeClass(fineStatus)} badge--status">${fineStatus}</span></div>
          </div>
          <div class="form-group">
            <label class="form-label">Статус списания</label>
            <div><span class="badge ${writeOffStatusClass} badge--status">${writeOffStatus}</span></div>
          </div>
          <div class="form-group">
            <label class="form-label">Дата и время списания</label>
            <div>${writeOffDateTime}</div>
          </div>
        </div>
      `;

      // Generate PP function
      window.generatePP = function() {
        if (!fine) return;
        alert(`Генерация ПП для штрафа #${fine.id}\nНомер постановления: ${resolutionNumber}\nДата: ${formatDate(fine.date)}\nАвто: ${fine.plate}\nВодитель: ${fine.driverName}\nСумма: ${formatCurrency(fine.amount)}`);
        // Здесь можно добавить реальную логику генерации ПП
      };
    }
  </script>
</body>
</html>
