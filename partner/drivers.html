<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Водители - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link active">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <h1>Водители</h1>

      <div class="filters">
        <div class="filter-group">
          <label><input type="checkbox" class="form-checkbox" id="hasDebtFilter"> Есть задолженность</label>
        </div>
        <div class="filter-group">
          <label class="form-label">Статус:</label>
          <select class="form-select" id="statusFilter" style="width: 200px;">
            <option value="">Все</option>
            <option value="Работает">Работает</option>
            <option value="Неактивен">Неактивен</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Поиск:</label>
          <input type="text" class="form-input" id="searchInput" placeholder="ФИО" style="width: 200px;">
        </div>
      </div>

      <table class="table" id="driversTable">
        <thead>
          <tr>
            <th>ФИО</th>
            <th>Статус</th>
            <th>Действующий договор</th>
            <th>Текущее ТС</th>
            <th>Задолженность</th>
            <th>Количество дней оплаченной аренды</th>
            <th>Сумма оплаченной аренды</th>
          </tr>
        </thead>
        <tbody id="driversTableBody"></tbody>
      </table>
    </main>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    function findCarByPlate(plate) {
      if (!plate) return null;
      const normalizedPlate = plate.toString().trim().toLowerCase();
      return mockData.cars.find((car) => (car.plate || '').toString().trim().toLowerCase() === normalizedPlate) || null;
    }

    function isActiveContract(contract) {
      const normalizedStatus = (contract?.status || '').toString().trim().toLowerCase();
      return normalizedStatus === 'действующий';
    }

    function getDriverActiveContract(driverId) {
      return getRentContractsByDriverId(driverId).find(isActiveContract) || null;
    }

    function getPaidRentStats(driverId) {
      const rentExpenses = getFinanceTransactionsByDriverId(driverId).filter((transaction) => {
        const section = (transaction.section || '').toString().trim().toLowerCase();
        const description = (transaction.description || '').toString().trim().toLowerCase();
        return section === 'аренда' && Number(transaction.expense) > 0 && description.includes('аренда');
      });

      const paidDays = rentExpenses.length;
      const paidAmount = rentExpenses.reduce((total, transaction) => total + (Number(transaction.expense) || 0), 0);

      return { paidDays, paidAmount };
    }

    function renderDrivers() {
      const tbody = document.getElementById('driversTableBody');
      tbody.innerHTML = mockData.drivers.map(driver => `
        <tr data-driver-status="${driver.status}" data-has-debt="${driver.debtAmount > 0 ? '1' : '0'}" onclick="window.location.href='driver.html?id=${driver.id}'">
          <td>${driver.name}</td>
          <td>${driver.status ? `<span class="badge ${getStatusBadgeClass(driver.status)}">${driver.status}</span>` : '-'}</td>
          <td>${
            (() => {
              const activeContract = getDriverActiveContract(driver.id);
              if (!activeContract) return '-';
              return `<a href="contract.html?id=${activeContract.id}" onclick="event.stopPropagation();">${activeContract.number}</a>`;
            })()
          }</td>
          <td>${
            (() => {
              if (!driver.currentCarPlate) return '-';
              const currentCar = findCarByPlate(driver.currentCarPlate);
              if (!currentCar) return driver.currentCarPlate;
              return `<a href="car.html?id=${currentCar.id}" onclick="event.stopPropagation();">${driver.currentCarPlate}</a>`;
            })()
          }</td>
          <td>${driver.debtAmount > 0 ? '<span style="color: var(--g-color-base-danger);">' + formatCurrency(driver.debtAmount) + '</span>' : '-'}</td>
          <td>${getPaidRentStats(driver.id).paidDays}</td>
          <td>${formatCurrency(getPaidRentStats(driver.id).paidAmount)}</td>
        </tr>
      `).join('');
    }

    function applyFilters() {
      const hasDebt = document.getElementById('hasDebtFilter').checked;
      const status = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();

      filterTable('#driversTable', (row) => {
        const rowStatus = (row.dataset.driverStatus || '').trim();
        const rowHasDebt = row.dataset.hasDebt === '1';
        const name = row.cells[0]?.textContent.toLowerCase() || '';

        if (hasDebt && !rowHasDebt) return false;
        if (status && rowStatus !== status) return false;
        if (search && !name.includes(search)) return false;
        return true;
      });
    }

    document.getElementById('hasDebtFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    renderDrivers();
  </script>
</body>
</html>
