<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Договора аренды - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link active">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Договора аренды</h1>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label class="form-label">Статус действия:</label>
          <select class="form-select" id="statusFilter" style="width: 200px;">
            <option value="">Все</option>
            <option value="Не действующий">Не действующий</option>
            <option value="Действующий">Действующий</option>
            <option value="Закрытый">Закрытый</option>
            <option value="Аннулирован">Аннулирован</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Статус договора:</label>
          <select class="form-select" id="contractStatusFilter" style="width: 250px;">
            <option value="">Все</option>
            <option value="Новый">Новый</option>
            <option value="Требует подписания">Требует подписания</option>
            <option value="Подписан">Подписан</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Статус выдачи:</label>
          <select class="form-select" id="issuanceStatusFilter" style="width: 220px;">
            <option value="">Все</option>
            <option value="Авто не выдано">Авто не выдано</option>
            <option value="Авто выдано">Авто выдано</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="form-label">Поиск по ФИО:</label>
          <input type="text" class="form-input" id="searchInput" placeholder="Введите ФИО водителя" style="width: 240px;">
        </div>
        <div class="filter-group">
          <label class="form-label">Период:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="date" class="form-input" id="dateFrom" style="width: 150px;">
            <span style="color: var(--g-color-text-secondary);">—</span>
            <input type="date" class="form-input" id="dateTo" style="width: 150px;">
          </div>
        </div>
      </div>

      <table class="table" id="contractsTable">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Номер</th>
            <th>Статус договора</th>
            <th>Статус действия</th>
            <th>Выдача</th>
            <th>Транспортное средство</th>
            <th>Водитель</th>
            <th data-sort-key="startDate" style="cursor: pointer; user-select: none;">Начало действия <span data-sort-indicator="startDate"></span></th>
            <th data-sort-key="endDate" style="cursor: pointer; user-select: none;">Окончание действия <span data-sort-indicator="endDate"></span></th>
            <th>График аренды</th>
            <th data-sort-key="days" style="cursor: pointer; user-select: none;">Количество дней в аренде <span data-sort-indicator="days"></span></th>
            <th data-sort-key="dailyRent" style="cursor: pointer; user-select: none;">Стоимость аренды в сутки <span data-sort-indicator="dailyRent"></span></th>
            <th data-sort-key="totalAmount" style="cursor: pointer; user-select: none;">Итоговая стоимость аренды <span data-sort-indicator="totalAmount"></span></th>
          </tr>
        </thead>
        <tbody id="contractsTableBody">
          <!-- Will be populated by JS -->
        </tbody>
      </table>
    </main>
  </div>

  <!-- Add Contract Modal -->
  <div class="modal" id="addContractModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">Добавить договор</h3>
        <button class="modal__close" data-close-modal="#addContractModal">×</button>
      </div>
      <div class="modal__body">
        <form id="addContractForm">
        <div class="form-group">
          <label class="form-label">Номер договора *</label>
          <input type="text" class="form-input" id="contractNumber" required placeholder="ДР-2024-001">
        </div>
        <div class="form-group">
          <label class="form-label">Водитель *</label>
          <select class="form-input" id="contractDriver" required>
            <option value="">Выберите водителя</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Транспортное средство *</label>
          <select class="form-input" id="contractVehicle" required>
            <option value="">Выберите ТС</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Начало действия *</label>
          <input type="date" class="form-input" id="contractStartDate" required>
        </div>
        <div class="form-group">
          <label class="form-label">Окончание действия</label>
          <input type="date" class="form-input" id="contractEndDate">
        </div>
        <div class="form-group">
          <label class="form-label">Стоимость аренды в сутки *</label>
          <input type="number" class="form-input" id="contractDailyRent" required min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label">График аренды *</label>
          <select class="form-input" id="contractSchedule" required>
            <option value="5/2">5/2</option>
            <option value="6/1">6/1</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; margin-top: var(--g-spacing-xl); padding-top: var(--g-spacing-lg); border-top: 1px solid var(--g-color-line-generic);">
          <button type="submit" class="btn btn--primary" style="flex: 1;">Добавить</button>
          <button type="button" class="btn btn--normal" data-close-modal="#addContractModal">Отмена</button>
        </div>
      </form>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    // Helper function to calculate days
    function calculateDays(startDate, endDate) {
      if (!startDate || !endDate) return 0;
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    // Helper function to calculate total amount
    function calculateTotalAmount(dailyRent, days) {
      return dailyRent * days;
    }

    const sortState = {
      key: null,
      direction: 'asc'
    };

    function normalizeContractStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === 'подписанный скан загружен' || normalized === 'подписан') return 'Подписан';
      if (normalized === 'требуется подписание' || normalized === 'требует подписания') return 'Требует подписания';
      return 'Новый';
    }

    function normalizeActionStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === 'действующий') return 'Действующий';
      if (normalized === 'истекший' || normalized === 'не действующий' || normalized === 'недействующий') return 'Не действующий';
      if (normalized === 'закрытый' || normalized === 'закрыт') return 'Закрытый';
      if (normalized === 'аннулирован' || normalized === 'аннулирова' || normalized === 'анулирова' || normalized === 'анулирован') return 'Аннулирован';
      return normalized ? 'Не действующий' : 'Действующий';
    }

    function normalizeIssuanceStatus(status) {
      const normalized = (status || '').toString().trim().toLowerCase();
      if (normalized === 'авто выдано') return 'Авто выдано';
      return 'Авто не выдано';
    }

    function normalizeRentSchedule(schedule) {
      return schedule === '6/1' ? '6/1' : '5/2';
    }

    function normalizeContract(contract) {
      contract.contractStatus = normalizeContractStatus(contract.contractStatus);
      contract.status = normalizeActionStatus(contract.status);
      contract.issuanceStatus = normalizeIssuanceStatus(contract.issuanceStatus);
      contract.rentSchedule = normalizeRentSchedule(contract.rentSchedule);
      return contract;
    }

    function getContractDays(contract) {
      return calculateDays(contract.startDate, contract.endDate);
    }

    function getContractTotalAmount(contract) {
      const days = getContractDays(contract);
      return contract.totalAmount || calculateTotalAmount(contract.dailyRent, days);
    }

    function getSortValue(contract, sortKey) {
      if (sortKey === 'startDate') return contract.startDate ? new Date(contract.startDate).getTime() : -Infinity;
      if (sortKey === 'endDate') return contract.endDate ? new Date(contract.endDate).getTime() : -Infinity;
      if (sortKey === 'days') return getContractDays(contract);
      if (sortKey === 'dailyRent') return Number(contract.dailyRent) || 0;
      if (sortKey === 'totalAmount') return Number(getContractTotalAmount(contract)) || 0;
      return 0;
    }

    function updateSortIndicators() {
      document.querySelectorAll('#contractsTable [data-sort-indicator]').forEach((indicator) => {
        const key = indicator.dataset.sortIndicator;
        if (sortState.key !== key) {
          indicator.textContent = '';
          return;
        }
        indicator.textContent = sortState.direction === 'asc' ? '↑' : '↓';
      });
    }

    function initSorting() {
      const sortableHeaders = document.querySelectorAll('#contractsTable th[data-sort-key]');
      sortableHeaders.forEach((header) => {
        header.addEventListener('click', () => {
          const key = header.dataset.sortKey;
          if (!key) return;
          if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = key;
            sortState.direction = 'asc';
          }
          renderContracts();
        });
      });
    }

    function renderContracts() {
      const tbody = document.getElementById('contractsTableBody');
      if (!tbody) return;

      let contracts = getAllRentContracts().map(normalizeContract);

      // Apply filters
      const statusFilter = document.getElementById('statusFilter')?.value;
      const contractStatusFilter = document.getElementById('contractStatusFilter')?.value;
      const issuanceStatusFilter = document.getElementById('issuanceStatusFilter')?.value;
      const searchInput = document.getElementById('searchInput')?.value.toLowerCase();
      const dateFrom = document.getElementById('dateFrom')?.value;
      const dateTo = document.getElementById('dateTo')?.value;

      if (statusFilter) {
        contracts = contracts.filter(c => c.status === statusFilter);
      }
      if (contractStatusFilter) {
        contracts = contracts.filter(c => c.contractStatus === contractStatusFilter);
      }
      if (issuanceStatusFilter) {
        contracts = contracts.filter(c => c.issuanceStatus === issuanceStatusFilter);
      }
      if (searchInput) {
        contracts = contracts.filter(c => c.driverName.toLowerCase().includes(searchInput));
      }
      if (dateFrom || dateTo) {
        contracts = contracts.filter(c => {
          const contractDate = new Date(c.date);
          if (dateFrom && contractDate < new Date(dateFrom)) return false;
          if (dateTo && contractDate > new Date(dateTo)) return false;
          return true;
        });
      }

      if (sortState.key) {
        const direction = sortState.direction === 'asc' ? 1 : -1;
        contracts.sort((a, b) => {
          const valueA = getSortValue(a, sortState.key);
          const valueB = getSortValue(b, sortState.key);
          if (valueA === valueB) return 0;
          return valueA > valueB ? direction : -direction;
        });
      }

      if (contracts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 40px; color: var(--g-color-text-secondary);">Договора не найдены</td></tr>';
        updateSortIndicators();
        return;
      }

      function getContractStatusBadgeClass(status) {
        if (status === 'Подписан') return 'badge--success';
        if (status === 'Требует подписания') return 'badge--warning';
        if (status === 'Новый') return 'badge--info';
        return 'badge--neutral';
      }

      function getIssuanceStatusBadgeClass(status) {
        if (status === 'Авто выдано') return 'badge--success';
        return 'badge--neutral';
      }

        tbody.innerHTML = contracts.map(contract => {
          const statusClass = contract.status === 'Действующий'
            ? 'badge--success'
            : (contract.status === 'Аннулирован' ? 'badge--danger' : 'badge--neutral');
          const contractStatusClass = getContractStatusBadgeClass(contract.contractStatus || 'Новый');
          const issuanceStatusClass = getIssuanceStatusBadgeClass(contract.issuanceStatus || '');
          const vehicleInfo = `${contract.vehicleName} ${contract.vehiclePlate}`.trim();
          const issuanceStatus = contract.issuanceStatus || 'Авто не выдано';
          
          // Calculate days and total amount
          const days = getContractDays(contract);
          const totalAmount = getContractTotalAmount(contract);
          
          return `
            <tr style="cursor: pointer;" onclick="window.location.href='contract.html?id=${contract.id}'">
              <td>${formatDateTime(contract.date)}</td>
              <td>${contract.number}</td>
              <td><span class="badge ${contractStatusClass}">${contract.contractStatus || 'Новый'}</span></td>
              <td><span class="badge ${statusClass}">${contract.status}</span></td>
              <td><span class="badge ${issuanceStatusClass}">${issuanceStatus}</span></td>
              <td>${vehicleInfo}</td>
              <td>${contract.driverName}</td>
              <td>${formatDate(contract.startDate)}</td>
              <td>${formatDate(contract.endDate)}</td>
              <td>${contract.rentSchedule}</td>
              <td>${days} ${days === 1 ? 'день' : days < 5 ? 'дня' : 'дней'}</td>
              <td>${formatCurrency(contract.dailyRent)}</td>
              <td>${formatCurrency(totalAmount)}</td>
            </tr>
          `;
        }).join('');
      updateSortIndicators();
    }

    function populateFilters() {
      // Populate contract driver select in modal
      const contractDriver = document.getElementById('contractDriver');
      if (contractDriver) {
        mockData.drivers.forEach(driver => {
          const option = document.createElement('option');
          option.value = driver.id;
          option.textContent = driver.name;
          contractDriver.appendChild(option);
        });
      }

      // Populate contract vehicle select in modal
      const contractVehicle = document.getElementById('contractVehicle');
      if (contractVehicle) {
        mockData.cars.forEach(car => {
          const option = document.createElement('option');
          option.value = car.plate;
          option.textContent = `${car.brand} ${car.model} (${car.plate})`;
          contractVehicle.appendChild(option);
        });
      }
    }

    function applyFilters() {
      renderContracts();
    }

    // Initialize modal
    initModal('#addContractModal', '[data-open-modal="#addContractModal"]', '[data-close-modal="#addContractModal"]');

    // Add event listeners
    document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('contractStatusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('issuanceStatusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('searchInput')?.addEventListener('input', applyFilters);
    document.getElementById('dateFrom')?.addEventListener('change', applyFilters);
    document.getElementById('dateTo')?.addEventListener('change', applyFilters);

    // Form submission
    const addContractForm = document.getElementById('addContractForm');
    if (addContractForm) {
      addContractForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = {
          number: document.getElementById('contractNumber').value.trim(),
          driverId: parseInt(document.getElementById('contractDriver').value),
          vehiclePlate: document.getElementById('contractVehicle').value.trim(),
          startDate: document.getElementById('contractStartDate').value,
          endDate: document.getElementById('contractEndDate').value || null,
          dailyRent: parseFloat(document.getElementById('contractDailyRent').value),
          rentSchedule: document.getElementById('contractSchedule').value
        };

        // Get driver and vehicle info
        const driver = getDriverById(formData.driverId);
        const car = mockData.cars.find(c => c.plate === formData.vehiclePlate);
        
        if (!driver || !car) {
          alert('Ошибка: не найден водитель или ТС');
          return;
        }

        // Calculate days and total amount
        const days = formData.endDate ? calculateDays(formData.startDate, formData.endDate) : 0;
        const totalAmount = calculateTotalAmount(formData.dailyRent, days);

        // Create new contract
        const newId = Math.max(...mockData.rentContracts.map(c => c.id), 0) + 1;
        const newContract = {
          id: newId,
          driverId: formData.driverId,
          date: new Date().toISOString(),
          number: formData.number,
          status: formData.endDate && new Date(formData.endDate) < new Date() ? 'Не действующий' : 'Действующий',
          contractStatus: 'Новый',
          scanUploaded: false,
          issuanceStatus: 'Авто не выдано',
          vehicleName: `${car.brand} ${car.model}`,
          vehiclePlate: formData.vehiclePlate,
          startDate: formData.startDate,
          endDate: formData.endDate,
          rentSchedule: normalizeRentSchedule(formData.rentSchedule),
          dailyRent: formData.dailyRent,
          totalAmount: totalAmount,
          driverName: driver.name
        };

        mockData.rentContracts.push(newContract);
        renderContracts();
        document.getElementById('addContractModal').classList.remove('active');
        addContractForm.reset();
      });
    }

    populateFilters();
    initSorting();
    renderContracts();
  </script>
</body>
</html>
