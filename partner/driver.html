<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карточка водителя - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link active">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <a href="drivers.html" class="back-link">← Назад к списку</a>

      <div id="driverHeader" style="margin-bottom: 32px;"></div>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
        <button class="btn btn--action" data-open-modal="#editDriverModal">Редактировать</button>
      </div>

      <div class="tabs" id="driverTabs">
        <button class="tab active" data-tab="main">Основное</button>
        <button class="tab" data-tab="rent-contracts">Договора аренды</button>
        <button class="tab" data-tab="finance">Транзакции</button>
        <button class="tab" data-tab="fines">Штрафы</button>
        <button class="tab" data-tab="change-history">История изменений</button>
      </div>

      <div class="tab-content active" data-tab="main">
          <h2>Основная информация</h2>
        <div class="card" id="driverMainInfo" style="margin-bottom: var(--g-spacing-xl);"></div>
      </div>

      <div class="tab-content" data-tab="rent-contracts">
        <div class="card">
          <h2>Договора аренды</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Номер</th>
                <th>Статус договора</th>
                <th>Статус действия</th>
                <th>Выдача</th>
                <th>Транспортное средство</th>
                <th>Водитель</th>
                <th>Начало действия</th>
                <th>Окончание действия</th>
                <th>График аренды</th>
                <th>Количество дней в аренде</th>
                <th>Стоимость аренды в сутки</th>
                <th>Итоговая стоимость аренды</th>
              </tr>
            </thead>
            <tbody id="rentContractsTableBody">
              <!-- Will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" data-tab="finance">
        <div class="card">
              <div class="alert alert--danger debt-banner" style="display: none;">
                Есть задолженность
              </div>
              <div style="margin-bottom: 24px; padding: 16px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md);">
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Типы транзакций:</label>
                    <div style="margin-top: 4px;">
                      <select class="form-select" id="financeTypeFilter" style="width: 180px;">
                        <option value="аренда">Аренда</option>
                        <option value="штраф">Штраф</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Период транзакций:</label>
                    <div style="display: flex; gap: 8px; margin-top: 4px; align-items: center;">
                      <input type="date" class="form-input" id="financeDateFrom" style="width: 150px;">
                      <span style="color: var(--g-color-text-secondary);">—</span>
                      <input type="date" class="form-input" id="financeDateTo" style="width: 150px;">
                    </div>
                  </div>
                </div>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Типы транзакций</th>
                    <th>Время</th>
                    <th>Сумма транзакции</th>
                    <th>Основание транзакции</th>
                  </tr>
                </thead>
                <tbody id="financeTableBody">
                  <!-- Will be populated by JS -->
                </tbody>
              </table>
            </div>
        </div>

      <div class="tab-content" data-tab="fines">
        <div class="card">
              <div style="margin-bottom: 24px; padding: 16px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md);">
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Статус штрафа:</label>
                    <div style="margin-top: 4px;">
                      <select class="form-select" id="fineStatusFilter" style="width: 200px;">
                        <option value="">Все</option>
                        <option value="Новый">Новый</option>
                        <option value="Оплачен">Оплачен</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Статус списания:</label>
                    <div style="margin-top: 4px;">
                      <select class="form-select" id="fineWriteOffStatusFilter" style="width: 220px;">
                        <option value="">Все</option>
                        <option value="Сумма списана">Сумма списана</option>
                        <option value="Сумма не списана">Сумма не списана</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Номер постановления:</label>
                    <div style="margin-top: 4px;">
                      <input type="text" class="form-input" id="fineResolutionSearch" placeholder="Поиск по номеру" style="width: 220px;">
                    </div>
                  </div>
                </div>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Номер постановления</th>
                    <th>Авто</th>
                    <th>Сумма</th>
                    <th>Статус штрафа</th>
                    <th>Статус списания</th>
                    <th>Дата и время списания</th>
                    <th>Действие</th>
                  </tr>
                </thead>
                <tbody id="driverFinesTableBody">                </tbody>
              </table>
            </div>
        </div>

      <div class="tab-content" data-tab="change-history">
        <div class="card">
          <h2 style="margin: 0 0 24px 0;">История изменений</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Дата время</th>
                <th>Поле измененное</th>
                <th>Значение было</th>
                <th>Значение стало</th>
                <th>ФИО редактора</th>
              </tr>
            </thead>
            <tbody id="changeHistoryTableBody">
              <!-- Will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="fileModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">Просмотр файла</h3>
        <button class="modal__close" data-close-modal="#fileModal">×</button>
      </div>
      <div style="text-align: center; padding: 40px;">
        <p style="color: var(--g-color-text-secondary);">Превью файла</p>
        <div style="width: 100%; height: 300px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md); margin-top: 20px; display: flex; align-items: center; justify-content: center;">
          <span style="color: var(--g-color-text-hint);">Placeholder изображения</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="editDriverModal">
    <div class="modal__content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal__header">
        <h3 class="modal__title">Редактирование водителя</h3>
        <button class="modal__close" data-close-modal="#editDriverModal">×</button>
      </div>
      <div class="modal__body" style="padding: var(--g-spacing-xl);">
        <form id="editDriverForm">
          <div style="margin-bottom: 32px;">
            <h4>Паспортные данные</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">Серия/номер (без пробелов)</label>
                <input type="text" class="form-input" id="editPassportSeries" placeholder="Серия" style="width: 48%; display: inline-block;">
                <input type="text" class="form-input" id="editPassportNumber" placeholder="Номер" style="width: 48%; display: inline-block; margin-left: 4%;">
              </div>
              <div class="form-group">
                <label class="form-label">Гражданство</label>
                <input type="text" class="form-input" id="editCitizenship" name="citizenship">
              </div>
              <div class="form-group">
                <label class="form-label">Кем выдан</label>
                <input type="text" class="form-input" id="editPassportIssuedBy" name="passportIssuedBy">
              </div>
              <div class="form-group">
                <label class="form-label">Пол</label>
                <select class="form-input" id="editGender" name="gender">
                  <option value="Мужской">Мужской</option>
                  <option value="Женский">Женский</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Дата выдачи</label>
                <input type="date" class="form-input" id="editPassportIssueDate" name="passportIssueDate">
              </div>
              <div class="form-group">
                <label class="form-label">Срок действия</label>
                <input type="date" class="form-input" id="editPassportValidUntil" name="passportValidUntil">
              </div>
              <div class="form-group">
                <label class="form-label">Код подразделения</label>
                <input type="text" class="form-input" id="editPassportDepartmentCode" name="passportDepartmentCode">
              </div>
              <div class="form-group">
                <label class="form-label">Адрес регистрации</label>
                <input type="text" class="form-input" id="editRegistrationAddress" name="registrationAddress">
              </div>
              <div class="form-group">
                <label class="form-label">Дата рождения</label>
                <input type="date" class="form-input" id="editBirthDate" name="birthDate">
              </div>
              <div class="form-group">
                <label class="form-label">Место рождения</label>
                <input type="text" class="form-input" id="editBirthPlace" name="birthPlace">
              </div>
            </div>
          </div>

          <div style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 12px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <button type="button" class="btn btn--normal" data-close-modal="#editDriverModal">Отмена</button>
            <button type="submit" class="btn btn--action">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    const driverId = getUrlParameter('id');
    const driver = getDriverById(driverId);

    if (!driver) {
      document.body.innerHTML = '<div class="container"><h1>Водитель не найден</h1><a href="drivers.html">Вернуться к списку</a></div>';
    } else {
      document.getElementById('driverHeader').innerHTML = `
        <h1>${driver.name}</h1>
        <div style="margin-top: 12px;">
          <span class="badge ${getStatusBadgeClass(driver.status)}">${driver.status}</span>
        </div>
      `;

      // Helper function to format date
      const formatDateDisplay = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      };

      // Ensure all fields have values
      const driverName = driver.name || '-';
      const driverPhone = driver.phone || '-';
      const driverStatus = driver.status || '-';
      const driverMyTaxPhone = driver.myTaxPhone || '-';

      // Build main info HTML
      let mainInfoHTML = `
        <div style="margin-bottom: 32px;">
          <h3>Основное</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">ФИО</label>
              <div id="driverFullName" style="min-height: 24px;">${driverName}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Статус</label>
              <div id="driverStatus" style="min-height: 24px;">
                ${driverStatus !== '-' ? `<span class="badge ${getStatusBadgeClass(driverStatus)}">${driverStatus}</span>` : '-'}
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Телефон (формат +79123456789)</label>
              <div id="driverPhone" style="min-height: 24px;">${driverPhone}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Телефон "Мой налог"</label>
              <div id="driverMyTaxPhone" style="min-height: 24px;">${driverMyTaxPhone}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Паспорт</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Серия/номер (без пробелов)</label>
              <div style="min-height: 24px;">${driver.passportSeries && driver.passportNumber ? `${driver.passportSeries} ${driver.passportNumber}` : '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Гражданство</label>
              <div style="min-height: 24px;">${driver.citizenship || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Кем выдан</label>
              <div style="min-height: 24px;">${driver.passportIssuedBy || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Пол</label>
              <div style="min-height: 24px;">${driver.gender || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата выдачи</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.passportIssueDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Срок действия</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.passportValidUntil)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата регистрации</label>
              <div style="min-height: 24px;">-</div>
            </div>
            <div class="form-group">
              <label class="form-label">Код подразделения</label>
              <div style="min-height: 24px;">${driver.passportDepartmentCode || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Адрес регистрации</label>
              <div style="min-height: 24px;">${driver.registrationAddress || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата рождения</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.birthDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Фактический адрес проживания</label>
              <div style="min-height: 24px;">-</div>
            </div>
            <div class="form-group">
              <label class="form-label">Место рождения</label>
              <div style="min-height: 24px;">${driver.birthPlace || '-'}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Водительские права</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Серия/номер (без пробелов)</label>
              <div style="min-height: 24px;">${driver.licenseSeries && driver.licenseNumber ? `${driver.licenseSeries} ${driver.licenseNumber}` : '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата начала водительского стажа</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseExperienceStartDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата выдачи</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseIssueDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Страна выдачи</label>
              <div style="min-height: 24px;">${driver.licenseCountry || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Срок действия</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseValidUntil)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Недействительны</label>
              <div style="min-height: 24px;">${driver.licenseInvalid ? 'Да' : 'Нет'}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Условия аренды</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Условие аренды</label>
              <div style="min-height: 24px;">${driver.workCondition || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата начала списания</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.writeOffStartDate)}</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('driverMainInfo').innerHTML = mainInfoHTML;

      const driverFines = mockData.fines.filter(f => f.driverName === driver.name);
      function normalizeFineStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        return normalized === 'оплачен' ? 'Оплачен' : 'Новый';
      }

      function getFineWriteOffStatus(fine) {
        return normalizeFineStatus(fine.status) === 'Оплачен' ? 'Сумма списана' : 'Сумма не списана';
      }

      function getFineWriteOffDateTime(fine) {
        if (fine.writeOffDateTime) return formatDateTime(fine.writeOffDateTime);
        if (fine.paidDate) return formatDateTime(`${fine.paidDate}T00:00:00`);
        return '-';
      }

      function getFineResolutionNumber(fine) {
        const providedNumber = (fine.resolutionNumber || '').toString().replace(/\D/g, '');
        if (providedNumber) return providedNumber;
        const datePart = (fine.date || '').toString().replace(/\D/g, '');
        return `${datePart}${String(fine.id).padStart(3, '0')}`;
      }

      function getCarLinkByPlate(plate) {
        const normalizedPlate = (plate || '').toString().trim().toLowerCase();
        const car = mockData.cars.find((item) => (item.plate || '').toString().trim().toLowerCase() === normalizedPlate);
        if (!car) return plate || '-';
        return `<a href="car.html?id=${car.id}" onclick="event.stopPropagation();">${plate}</a>`;
      }

      function renderDriverFinesTable() {
        const fineStatusFilter = document.getElementById('fineStatusFilter')?.value || '';
        const fineWriteOffStatusFilter = document.getElementById('fineWriteOffStatusFilter')?.value || '';
        const fineResolutionSearch = (document.getElementById('fineResolutionSearch')?.value || '').replace(/\D/g, '');
        const finesTableBody = document.getElementById('driverFinesTableBody');
        if (!finesTableBody) return;

        const filteredFines = driverFines.filter((fine) => {
          const fineStatus = normalizeFineStatus(fine.status);
          const writeOffStatus = getFineWriteOffStatus(fine);
          const resolutionNumber = getFineResolutionNumber(fine);

          if (fineStatusFilter && fineStatus !== fineStatusFilter) return false;
          if (fineWriteOffStatusFilter && writeOffStatus !== fineWriteOffStatusFilter) return false;
          if (fineResolutionSearch && !resolutionNumber.includes(fineResolutionSearch)) return false;
          return true;
        });

        finesTableBody.innerHTML = filteredFines.length > 0
          ? filteredFines.map((fine) => {
              const fineStatus = normalizeFineStatus(fine.status);
              const writeOffStatus = getFineWriteOffStatus(fine);
              const resolutionNumber = getFineResolutionNumber(fine);
              const writeOffStatusClass = writeOffStatus === 'Сумма списана' ? 'badge--success' : 'badge--neutral';
              const canGeneratePP = fineStatus === 'Новый';

              return `
                <tr>
                  <td>${formatDate(fine.date)}</td>
                  <td>${resolutionNumber}</td>
                  <td>${getCarLinkByPlate(fine.plate)}</td>
                  <td>${formatCurrency(fine.amount)}</td>
                  <td><span class="badge ${getStatusBadgeClass(fineStatus)}">${fineStatus}</span></td>
                  <td><span class="badge ${writeOffStatusClass}">${writeOffStatus}</span></td>
                  <td>${getFineWriteOffDateTime(fine)}</td>
                  <td>
                    ${canGeneratePP ? `<button class="btn btn--normal" onclick="generatePPForDriver(${fine.id})" style="white-space: nowrap;">Сгенерировать ПП</button>` : '-'}
                  </td>
                </tr>
              `;
            }).join('')
          : '<tr><td colspan="8" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';
      }

      renderDriverFinesTable();

      // Render rent contracts
      function normalizeContractStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'подписанный скан загружен' || normalized === 'подписан') return 'Подписан';
        if (normalized === 'требуется заполнение паспорта' || normalized === 'требуется подписание' || normalized === 'требует подписания') return 'Требует подписания';
        return 'Новый';
      }

      function normalizeActionStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'действующий') return 'Действующий';
        if (normalized === 'истекший' || normalized === 'не действующий' || normalized === 'недействующий') return 'Не действующий';
        if (normalized === 'закрытый' || normalized === 'закрыт') return 'Закрытый';
        if (normalized === 'аннулирован' || normalized === 'аннулирова' || normalized === 'анулирова' || normalized === 'анулирован') return 'Аннулирован';
        return normalized ? 'Не действующий' : 'Действующий';
      }

      function normalizeIssuanceStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'авто выдано') return 'Авто выдано';
        return 'Авто не выдано';
      }

      function normalizeRentSchedule(schedule) {
        return schedule === '6/1' ? '6/1' : '5/2';
      }

      function getContractDays(contract) {
        if (!contract.startDate || !contract.endDate) return 0;
        const start = new Date(contract.startDate);
        const end = new Date(contract.endDate);
        const diffTime = Math.abs(end - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }

      function getContractTotalAmount(contract) {
        const days = getContractDays(contract);
        return contract.totalAmount || (Number(contract.dailyRent) || 0) * days;
      }

      function getContractStatusBadgeClass(status) {
        if (status === 'Подписан') return 'badge--success';
        if (status === 'Требует подписания') return 'badge--warning';
        if (status === 'Новый') return 'badge--info';
        return 'badge--neutral';
      }

      function getIssuanceStatusBadgeClass(status) {
        if (status === 'Авто выдано') return 'badge--success';
        return 'badge--neutral';
      }

      const rentContracts = getRentContractsByDriverId(driverId);
      document.getElementById('rentContractsTableBody').innerHTML = rentContracts.length > 0 
        ? rentContracts.map(rawContract => {
            const contract = { ...rawContract };
            contract.contractStatus = normalizeContractStatus(contract.contractStatus);
            contract.status = normalizeActionStatus(contract.status);
            contract.issuanceStatus = normalizeIssuanceStatus(contract.issuanceStatus);
            contract.rentSchedule = normalizeRentSchedule(contract.rentSchedule);

            const statusClass = contract.status === 'Действующий'
              ? 'badge--success'
              : (contract.status === 'Аннулирован' ? 'badge--danger' : 'badge--neutral');
            const contractStatusClass = getContractStatusBadgeClass(contract.contractStatus || 'Новый');
            const issuanceStatusClass = getIssuanceStatusBadgeClass(contract.issuanceStatus || '');
            const vehicleInfo = `${contract.vehicleName} ${contract.vehiclePlate}`.trim();
            const normalizedPlate = (contract.vehiclePlate || '').toString().trim().toLowerCase();
            const car = mockData.cars.find((item) => (item.plate || '').toString().trim().toLowerCase() === normalizedPlate);
            const vehicleLink = car
              ? `<a href="car.html?id=${car.id}" onclick="event.stopPropagation();">${vehicleInfo}</a>`
              : vehicleInfo;
            const issuanceStatus = contract.issuanceStatus || 'Авто не выдано';
            const days = getContractDays(contract);
            const totalAmount = getContractTotalAmount(contract);

            return `
              <tr style="cursor: pointer;" onclick="window.location.href='contract.html?id=${contract.id}'">
                <td>${formatDateTime(contract.date)}</td>
                <td>${contract.number}</td>
                <td><span class="badge ${contractStatusClass}">${contract.contractStatus || 'Новый'}</span></td>
                <td><span class="badge ${statusClass}">${contract.status}</span></td>
                <td><span class="badge ${issuanceStatusClass}">${issuanceStatus}</span></td>
                <td>${vehicleLink}</td>
                <td>${contract.driverName}</td>
                <td>${formatDate(contract.startDate)}</td>
                <td>${formatDate(contract.endDate)}</td>
                <td>${contract.rentSchedule}</td>
                <td>${days} ${days === 1 ? 'день' : days < 5 ? 'дня' : 'дней'}</td>
                <td>${formatCurrency(contract.dailyRent)}</td>
                <td>${formatCurrency(totalAmount)}</td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="13" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';

      // Render change history
      const changeHistory = getChangeHistoryByDriverId(driverId);
      document.getElementById('changeHistoryTableBody').innerHTML = changeHistory.length > 0 
        ? changeHistory.map(history => `
          <tr>
            <td>${formatDateTime(history.dateTime)}</td>
            <td>${history.field}</td>
            <td>${history.oldValue || '-'}</td>
            <td>${history.newValue || '-'}</td>
            <td>${history.editorName}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="5" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';

      // Render finance transactions
      const financeTransactions = getFinanceTransactionsByDriverId(driverId);

      function getTransactionType(transaction) {
        const section = (transaction.section || '').toString().trim().toLowerCase();
        return section.includes('штраф') ? 'штраф' : 'аренда';
      }

      function getTransactionAmount(transaction) {
        const income = Number(transaction.income) || 0;
        const expense = Number(transaction.expense) || 0;
        if (income > 0) return income;
        if (expense > 0) return expense;
        return 0;
      }

      function getTransactionBasisMarkup(transaction, type) {
        if (type === 'штраф') {
          const fineByAmount = driverFines.find((fine) => Number(fine.amount) === getTransactionAmount(transaction));
          const fine = fineByAmount || driverFines[0] || null;
          if (!fine) return '-';
          return `<a href="fine.html?id=${fine.id}" onclick="event.stopPropagation();">Штраф #${fine.id}</a>`;
        }

        const contracts = getRentContractsByDriverId(driverId);
        const contractByAmount = contracts.find((contract) => Number(contract.dailyRent) === getTransactionAmount(transaction));
        const contract = contractByAmount || contracts[0] || null;
        if (!contract) return '-';
        return `<a href="contract.html?id=${contract.id}" onclick="event.stopPropagation();">${contract.number}</a>`;
      }

      // Function to render finance table
      function renderFinanceTable() {
        const financeTableBody = document.getElementById('financeTableBody');
        if (!financeTableBody) return;

        const dateFrom = document.getElementById('financeDateFrom')?.value;
        const dateTo = document.getElementById('financeDateTo')?.value;
        const typeFilter = document.getElementById('financeTypeFilter')?.value || 'аренда';

        let filteredTransactions = financeTransactions;

        filteredTransactions = filteredTransactions.filter((transaction) => getTransactionType(transaction) === typeFilter);

        if (dateFrom || dateTo) {
          filteredTransactions = financeTransactions.filter(t => {
            const transactionDate = new Date(t.date);
            if (dateFrom && transactionDate < new Date(dateFrom)) return false;
            if (dateTo && transactionDate > new Date(dateTo)) return false;
            return true;
          });
          filteredTransactions = filteredTransactions.filter((transaction) => getTransactionType(transaction) === typeFilter);
        }

        financeTableBody.innerHTML = filteredTransactions.length > 0
          ? filteredTransactions.map((transaction) => {
              const type = getTransactionType(transaction);
              const amount = getTransactionAmount(transaction);
              const basis = getTransactionBasisMarkup(transaction, type);

              return `
                <tr>
                  <td>${formatDate(transaction.date)}</td>
                  <td>${type}</td>
                  <td>${transaction.time}</td>
                  <td>${formatNumber(amount)}</td>
                  <td>${basis}</td>
                </tr>
              `;
            }).join('')
          : '<tr><td colspan="5" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';
      }

      // Initial render
      renderFinanceTable();

      // Add event listeners for date filters
      const financeDateFrom = document.getElementById('financeDateFrom');
      const financeDateTo = document.getElementById('financeDateTo');
      const financeTypeFilter = document.getElementById('financeTypeFilter');
      const fineStatusFilter = document.getElementById('fineStatusFilter');
      const fineWriteOffStatusFilter = document.getElementById('fineWriteOffStatusFilter');
      const fineResolutionSearch = document.getElementById('fineResolutionSearch');
      if (financeDateFrom) {
        financeDateFrom.addEventListener('change', renderFinanceTable);
      }
      if (financeDateTo) {
        financeDateTo.addEventListener('change', renderFinanceTable);
      }
      if (financeTypeFilter) {
        financeTypeFilter.addEventListener('change', renderFinanceTable);
      }
      if (fineStatusFilter) {
        fineStatusFilter.addEventListener('change', renderDriverFinesTable);
      }
      if (fineWriteOffStatusFilter) {
        fineWriteOffStatusFilter.addEventListener('change', renderDriverFinesTable);
      }
      if (fineResolutionSearch) {
        fineResolutionSearch.addEventListener('input', renderDriverFinesTable);
      }

      initTabs('#driverTabs');
      initModal('#fileModal', '[data-open-modal="#fileModal"]', '[data-close-modal="#fileModal"]');
      initModal('#editDriverModal', '[data-open-modal="#editDriverModal"]', '[data-close-modal="#editDriverModal"]');

      // Initialize edit form
      const editForm = document.getElementById('editDriverForm');
      if (editForm) {
        // Helper to format date for input[type="date"]
        const formatDateForInput = (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toISOString().split('T')[0];
        };

        // Populate passport fields
        document.getElementById('editPassportSeries').value = driver.passportSeries || '';
        document.getElementById('editPassportNumber').value = driver.passportNumber || '';
        document.getElementById('editCitizenship').value = driver.citizenship || '';
        document.getElementById('editPassportIssuedBy').value = driver.passportIssuedBy || '';
        document.getElementById('editGender').value = driver.gender || 'Мужской';
        document.getElementById('editPassportIssueDate').value = formatDateForInput(driver.passportIssueDate);
        document.getElementById('editPassportValidUntil').value = formatDateForInput(driver.passportValidUntil);
        document.getElementById('editPassportDepartmentCode').value = driver.passportDepartmentCode || '';
        document.getElementById('editRegistrationAddress').value = driver.registrationAddress || '';
        document.getElementById('editBirthDate').value = formatDateForInput(driver.birthDate);
        document.getElementById('editBirthPlace').value = driver.birthPlace || '';

        editForm.addEventListener('submit', (e) => {
          e.preventDefault();

          // Update passport data
          driver.passportSeries = document.getElementById('editPassportSeries').value;
          driver.passportNumber = document.getElementById('editPassportNumber').value;
          driver.citizenship = document.getElementById('editCitizenship').value;
          driver.passportIssuedBy = document.getElementById('editPassportIssuedBy').value;
          driver.gender = document.getElementById('editGender').value;
          driver.passportIssueDate = document.getElementById('editPassportIssueDate').value;
          driver.passportValidUntil = document.getElementById('editPassportValidUntil').value;
          driver.passportDepartmentCode = document.getElementById('editPassportDepartmentCode').value;
          driver.registrationAddress = document.getElementById('editRegistrationAddress').value;
          driver.birthDate = document.getElementById('editBirthDate').value;
          driver.birthPlace = document.getElementById('editBirthPlace').value;

          // Reload the page to show updated data
          location.reload();
        });
      }

      // Generate PP function for driver fines
      window.generatePPForDriver = function(fineId) {
        const fine = mockData.fines.find(f => f.id === fineId);
        if (!fine) {
          alert('Штраф не найден');
          return;
        }
        alert(`Генерация ПП для штрафа #${fineId}\nДата: ${formatDate(fine.date)}\nАвто: ${fine.plate}\nВодитель: ${fine.driverName}\nСумма: ${formatCurrency(fine.amount)}`);
        // Здесь можно добавить реальную логику генерации ПП
      };
    }
  </script>
</body>
</html>
