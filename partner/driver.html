<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карточка водителя - Кабинет партнёра</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <ul class="sidebar__menu">
        <li class="sidebar__item"><a href="contracts.html" class="sidebar__link">Договора</a></li>
        <li class="sidebar__item"><a href="cars.html" class="sidebar__link">Авто</a></li>
        <li class="sidebar__item"><a href="drivers.html" class="sidebar__link active">Водители</a></li>
        <li class="sidebar__item"><a href="fines.html" class="sidebar__link">Штрафы</a></li>
        <li class="sidebar__item" style="display: none;"><a href="service-orders.html" class="sidebar__link">Ремонты</a></li>
        <li class="sidebar__item"><a href="reports.html" class="sidebar__link">Отчёты</a></li>
        <li class="sidebar__item"><a href="users.html" class="sidebar__link">Пользователи</a></li>
        <li class="sidebar__item"><a href="profile.html" class="sidebar__link">Профиль</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <a href="drivers.html" class="back-link">← Назад к списку</a>

      <div id="driverHeader" style="margin-bottom: 32px;"></div>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 24px;">
        <button class="btn btn--action" data-open-modal="#editDriverModal">Редактировать</button>
      </div>

      <div class="tabs" id="driverTabs">
        <button class="tab active" data-tab="main">Основное</button>
        <button class="tab" data-tab="vehicle-history">История ТС</button>
        <button class="tab" data-tab="rent-contracts">Договора аренды</button>
        <button class="tab" data-tab="finance">Финансы</button>
        <button class="tab" data-tab="fines">Штрафы</button>
        <button class="tab" data-tab="change-history">История изменений</button>
      </div>

      <div class="tab-content active" data-tab="main">
          <h2>Основная информация</h2>
        <div class="card" id="driverMainInfo" style="margin-bottom: var(--g-spacing-xl);"></div>
        <div style="margin-top: var(--g-spacing-lg);">
          <button class="btn btn--normal" data-toggle="debt" data-driver-id="">Симулировать: есть задолженность</button>
        </div>
      </div>

      <div class="tab-content" data-tab="vehicle-history">
        <div class="card">
          <h2>История транспортных средств</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Наименование транспортного средства</th>
                <th>Госномер</th>
                <th>Дата выдачи</th>
                <th>Период окончания</th>
              </tr>
            </thead>
            <tbody id="vehicleHistoryTableBody">
              <!-- Will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" data-tab="rent-contracts">
        <div class="card">
          <h2>Договора аренды</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Номер</th>
                <th>Статус договора</th>
                <th>Статус действия</th>
                <th>Выдача</th>
                <th>Транспортное средство</th>
                <th>Водитель</th>
                <th>Начало действия</th>
                <th>Окончание действия</th>
                <th>График аренды</th>
                <th>Количество дней в аренде</th>
                <th>Стоимость аренды в сутки</th>
                <th>Итоговая стоимость аренды</th>
              </tr>
            </thead>
            <tbody id="rentContractsTableBody">
              <!-- Will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" data-tab="finance">
        <div class="card">
              <div class="alert alert--danger debt-banner" style="display: none;">
                Есть задолженность
              </div>
              <div style="margin-bottom: 24px; padding: 16px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md);">
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Разделы баланса:</label>
                    <div style="margin-top: 4px;">
                      <label style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;">
                        <input type="checkbox" checked> Аренда
                      </label>
                      <label style="display: inline-flex; align-items: center; gap: 4px; margin-right: 12px;">
                        <input type="checkbox" checked> Прочее
                      </label>
                      <label style="display: inline-flex; align-items: center; gap: 4px;">
                        <input type="checkbox" checked> Штрафы
                      </label>
                    </div>
                  </div>
                  <div>
                    <label style="font-size: 12px; color: var(--g-color-text-secondary);">Период:</label>
                    <div style="display: flex; gap: 8px; margin-top: 4px; align-items: center;">
                      <input type="date" class="form-input" id="financeDateFrom" style="width: 150px;">
                      <span style="color: var(--g-color-text-secondary);">—</span>
                      <input type="date" class="form-input" id="financeDateTo" style="width: 150px;">
                    </div>
                  </div>
                </div>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Раздел</th>
                    <th>Время</th>
                    <th>Приход</th>
                    <th>Расход</th>
                    <th>Остаток</th>
                    <th>Способ оплаты</th>
                    <th>Описание</th>
                  </tr>
                </thead>
                <tbody id="financeTableBody">
                  <!-- Will be populated by JS -->
                </tbody>
              </table>
            </div>
        </div>

      <div class="tab-content" data-tab="fines">
        <div class="card">
              <table class="table">
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Авто</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Действие</th>
                  </tr>
                </thead>
                <tbody id="driverFinesTableBody">                </tbody>
              </table>
            </div>
        </div>

      <div class="tab-content" data-tab="change-history">
        <div class="card">
          <h2 style="margin: 0 0 24px 0;">История изменений</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Дата время</th>
                <th>Поле измененное</th>
                <th>Значение было</th>
                <th>Значение стало</th>
                <th>ФИО редактора</th>
              </tr>
            </thead>
            <tbody id="changeHistoryTableBody">
              <!-- Will be populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="fileModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">Просмотр файла</h3>
        <button class="modal__close" data-close-modal="#fileModal">×</button>
      </div>
      <div style="text-align: center; padding: 40px;">
        <p style="color: var(--g-color-text-secondary);">Превью файла</p>
        <div style="width: 100%; height: 300px; background: var(--g-color-base-generic); border-radius: var(--g-border-radius-md); margin-top: 20px; display: flex; align-items: center; justify-content: center;">
          <span style="color: var(--g-color-text-hint);">Placeholder изображения</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="editDriverModal">
    <div class="modal__content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
      <div class="modal__header">
        <h3 class="modal__title">Редактирование водителя</h3>
        <button class="modal__close" data-close-modal="#editDriverModal">×</button>
      </div>
      <div class="modal__body" style="padding: var(--g-spacing-xl);">
        <form id="editDriverForm">
          <div style="margin-bottom: 32px;">
            <h4>Основное</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">ФИО</label>
                <input type="text" class="form-input" id="editFullName" name="fullName" required>
              </div>
              <div class="form-group">
                <label class="form-label">Статус</label>
                <select class="form-input" id="editStatus" name="status" required>
                  <option value="Работает">Работает</option>
                  <option value="Активен">Активен</option>
                  <option value="Неактивен">Неактивен</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 32px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <h4>Паспорт/СНИЛС</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">Серия/номер (без пробелов)</label>
                <input type="text" class="form-input" id="editPassportSeries" placeholder="Серия" style="width: 48%; display: inline-block;">
                <input type="text" class="form-input" id="editPassportNumber" placeholder="Номер" style="width: 48%; display: inline-block; margin-left: 4%;">
              </div>
              <div class="form-group">
                <label class="form-label">Гражданство</label>
                <input type="text" class="form-input" id="editCitizenship" name="citizenship">
              </div>
              <div class="form-group">
                <label class="form-label">Кем выдан</label>
                <input type="text" class="form-input" id="editPassportIssuedBy" name="passportIssuedBy">
              </div>
              <div class="form-group">
                <label class="form-label">Пол</label>
                <select class="form-input" id="editGender" name="gender">
                  <option value="Мужской">Мужской</option>
                  <option value="Женский">Женский</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Дата выдачи</label>
                <input type="date" class="form-input" id="editPassportIssueDate" name="passportIssueDate">
              </div>
              <div class="form-group">
                <label class="form-label">Срок действия</label>
                <input type="date" class="form-input" id="editPassportValidUntil" name="passportValidUntil">
              </div>
              <div class="form-group">
                <label class="form-label">Код подразделения</label>
                <input type="text" class="form-input" id="editPassportDepartmentCode" name="passportDepartmentCode">
              </div>
              <div class="form-group">
                <label class="form-label">Адрес регистрации</label>
                <input type="text" class="form-input" id="editRegistrationAddress" name="registrationAddress">
              </div>
              <div class="form-group">
                <label class="form-label">Дата рождения</label>
                <input type="date" class="form-input" id="editBirthDate" name="birthDate">
              </div>
              <div class="form-group">
                <label class="form-label">Место рождения</label>
                <input type="text" class="form-input" id="editBirthPlace" name="birthPlace">
              </div>
              <div class="form-group">
                <label class="form-label">СНИЛС</label>
                <input type="text" class="form-input" id="editSnils" name="snils">
              </div>
            </div>
          </div>

          <div style="margin-bottom: 32px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <h4>Водительские права</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">Серия/номер (без пробелов)</label>
                <input type="text" class="form-input" id="editLicenseSeries" placeholder="Серия" style="width: 48%; display: inline-block;">
                <input type="text" class="form-input" id="editLicenseNumber" placeholder="Номер" style="width: 48%; display: inline-block; margin-left: 4%;">
              </div>
              <div class="form-group">
                <label class="form-label">Дата начала водительского стажа</label>
                <input type="date" class="form-input" id="editLicenseExperienceStartDate" name="licenseExperienceStartDate">
              </div>
              <div class="form-group">
                <label class="form-label">Дата выдачи</label>
                <input type="date" class="form-input" id="editLicenseIssueDate" name="licenseIssueDate">
              </div>
              <div class="form-group">
                <label class="form-label">Страна выдачи</label>
                <input type="text" class="form-input" id="editLicenseCountry" name="licenseCountry">
              </div>
              <div class="form-group">
                <label class="form-label">Срок действия</label>
                <input type="date" class="form-input" id="editLicenseValidUntil" name="licenseValidUntil">
              </div>
              <div class="form-group">
                <label class="form-label">Недействительны</label>
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" class="form-checkbox" id="editLicenseInvalid" name="licenseInvalid">
                  <span>Недействительны</span>
                </label>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 32px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <h4>Условия работы</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
              <div class="form-group">
                <label class="form-label">Условие работы</label>
                <input type="text" class="form-input" id="editWorkCondition" name="workCondition">
              </div>
              <div class="form-group">
                <label class="form-label">Дата начала списания</label>
                <input type="date" class="form-input" id="editWriteOffStartDate" name="writeOffStartDate">
              </div>
            </div>
          </div>

          <div style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 12px; padding-top: 24px; border-top: 1px solid var(--g-color-line-generic);">
            <button type="button" class="btn btn--normal" data-close-modal="#editDriverModal">Отмена</button>
            <button type="submit" class="btn btn--action">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script src="../assets/js/ui-state.js"></script>
  <script>
    const driverId = getUrlParameter('id');
    const driver = getDriverById(driverId);

    if (!driver) {
      document.body.innerHTML = '<div class="container"><h1>Водитель не найден</h1><a href="drivers.html">Вернуться к списку</a></div>';
    } else {
      document.getElementById('driverHeader').innerHTML = `
        <h1>${driver.name}</h1>
        <div style="margin-top: 12px;">
          <span class="badge ${getStatusBadgeClass(driver.status)}">${driver.status}</span>
        </div>
      `;

      // Helper function to format date
      const formatDateDisplay = (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      };

      // Ensure all fields have values
      const driverName = driver.name || '-';
      const driverPhone = driver.phone || '-';
      const driverStatus = driver.status || '-';
      const driverMyTaxPhone = driver.myTaxPhone || '-';

      // Build main info HTML
      let mainInfoHTML = `
        <div style="margin-bottom: 32px;">
          <h3>Основное</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">ФИО</label>
              <div id="driverFullName" style="min-height: 24px;">${driverName}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Статус</label>
              <div id="driverStatus" style="min-height: 24px;">
                ${driverStatus !== '-' ? `<span class="badge ${getStatusBadgeClass(driverStatus)}">${driverStatus}</span>` : '-'}
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Телефон (формат +79123456789)</label>
              <div id="driverPhone" style="min-height: 24px;">${driverPhone}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Телефон "Мой налог"</label>
              <div id="driverMyTaxPhone" style="min-height: 24px;">${driverMyTaxPhone}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Паспорт</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Серия/номер (без пробелов)</label>
              <div style="min-height: 24px;">${driver.passportSeries && driver.passportNumber ? `${driver.passportSeries} ${driver.passportNumber}` : '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Гражданство</label>
              <div style="min-height: 24px;">${driver.citizenship || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Кем выдан</label>
              <div style="min-height: 24px;">${driver.passportIssuedBy || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Пол</label>
              <div style="min-height: 24px;">${driver.gender || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата выдачи</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.passportIssueDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Срок действия</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.passportValidUntil)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата регистрации</label>
              <div style="min-height: 24px;">-</div>
            </div>
            <div class="form-group">
              <label class="form-label">Код подразделения</label>
              <div style="min-height: 24px;">${driver.passportDepartmentCode || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Адрес регистрации</label>
              <div style="min-height: 24px;">${driver.registrationAddress || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата рождения</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.birthDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Фактический адрес проживания</label>
              <div style="min-height: 24px;">-</div>
            </div>
            <div class="form-group">
              <label class="form-label">Место рождения</label>
              <div style="min-height: 24px;">${driver.birthPlace || '-'}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>СНИЛС</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">СНИЛС</label>
              <div style="min-height: 24px;">${driver.snils || '-'}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Водительские права</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Серия/номер (без пробелов)</label>
              <div style="min-height: 24px;">${driver.licenseSeries && driver.licenseNumber ? `${driver.licenseSeries} ${driver.licenseNumber}` : '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата начала водительского стажа</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseExperienceStartDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата выдачи</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseIssueDate)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Страна выдачи</label>
              <div style="min-height: 24px;">${driver.licenseCountry || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Срок действия</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.licenseValidUntil)}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Недействительны</label>
              <div style="min-height: 24px;">${driver.licenseInvalid ? 'Да' : 'Нет'}</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 32px;">
          <h3>Условия работы</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
            <div class="form-group">
              <label class="form-label">Условие работы</label>
              <div style="min-height: 24px;">${driver.workCondition || '-'}</div>
            </div>
            <div class="form-group">
              <label class="form-label">Дата начала списания</label>
              <div style="min-height: 24px;">${formatDateDisplay(driver.writeOffStartDate)}</div>
            </div>
          </div>
        </div>
      `;

      // Add vehicle section as table
      if (driver.vehiclePlate || driver.currentCarPlate) {
        const vehiclePlate = driver.vehiclePlate || driver.currentCarPlate;
        const vehicleBrand = driver.vehicleBrand || '-';
        const vehicleModel = driver.vehicleModel || '-';
        const vehicleName = vehicleBrand !== '-' && vehicleModel !== '-' ? `${vehicleBrand} ${vehicleModel}` : '-';
        const vehicleStatus = driver.vehicleStatus || '-';

        mainInfoHTML += `
          <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--g-color-line-generic);">
            <h3>Текущее транспортное средство</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Наименование транспортного средства</th>
                  <th>Госномер</th>
                  <th>Статус</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${vehicleName}</td>
                  <td>${vehiclePlate}</td>
                  <td>${vehicleStatus !== '-' ? `<span class="badge ${getStatusBadgeClass(vehicleStatus)}">${vehicleStatus}</span>` : '-'}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }

      document.getElementById('driverMainInfo').innerHTML = mainInfoHTML;

      const driverFines = mockData.fines.filter(f => f.driverName === driver.name);
      document.getElementById('driverFinesTableBody').innerHTML = driverFines.map(fine => {
        const canGeneratePP = fine.status === 'Новый' || fine.status === 'Начислен';
        return `
        <tr>
          <td>${formatDate(fine.date)}</td>
          <td>${fine.plate}</td>
          <td>${formatCurrency(fine.amount)}</td>
          <td><span class="badge ${getStatusBadgeClass(fine.status)}">${fine.status}</span></td>
          <td>
            ${canGeneratePP ? `<button class="btn btn--normal" onclick="generatePPForDriver(${fine.id})" style="white-space: nowrap;">Сгенерировать ПП</button>` : '-'}
          </td>
        </tr>
      `;
      }).join('');

      // Render vehicle history
      const vehicleHistory = getVehicleHistoryByDriverId(driverId);
      document.getElementById('vehicleHistoryTableBody').innerHTML = vehicleHistory.length > 0 
        ? vehicleHistory.map(history => `
          <tr>
            <td>${history.vehicleName}</td>
            <td>${history.plate}</td>
            <td>${formatDateTime(history.issueDate)}</td>
            <td>${history.endDate ? formatDateTime(history.endDate) : '-'}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="4" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';

      // Render rent contracts
      function normalizeContractStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'подписанный скан загружен' || normalized === 'подписан') return 'Подписан';
        if (normalized === 'требуется заполнение паспорта' || normalized === 'требуется подписание' || normalized === 'требует подписания') return 'Требует подписания';
        return 'Новый';
      }

      function normalizeActionStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'действующий') return 'Действующий';
        if (normalized === 'истекший' || normalized === 'не действующий' || normalized === 'недействующий') return 'Не действующий';
        if (normalized === 'закрытый' || normalized === 'закрыт') return 'Закрытый';
        if (normalized === 'аннулирован' || normalized === 'аннулирова' || normalized === 'анулирова' || normalized === 'анулирован') return 'Аннулирован';
        return normalized ? 'Не действующий' : 'Действующий';
      }

      function normalizeIssuanceStatus(status) {
        const normalized = (status || '').toString().trim().toLowerCase();
        if (normalized === 'авто выдано') return 'Авто выдано';
        return 'Авто не выдано';
      }

      function normalizeRentSchedule(schedule) {
        return schedule === '6/1' ? '6/1' : '5/2';
      }

      function getContractDays(contract) {
        if (!contract.startDate || !contract.endDate) return 0;
        const start = new Date(contract.startDate);
        const end = new Date(contract.endDate);
        const diffTime = Math.abs(end - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }

      function getContractTotalAmount(contract) {
        const days = getContractDays(contract);
        return contract.totalAmount || (Number(contract.dailyRent) || 0) * days;
      }

      function getContractStatusBadgeClass(status) {
        if (status === 'Подписан') return 'badge--success';
        if (status === 'Требует подписания') return 'badge--warning';
        if (status === 'Новый') return 'badge--info';
        return 'badge--neutral';
      }

      function getIssuanceStatusBadgeClass(status) {
        if (status === 'Авто выдано') return 'badge--success';
        return 'badge--neutral';
      }

      const rentContracts = getRentContractsByDriverId(driverId);
      document.getElementById('rentContractsTableBody').innerHTML = rentContracts.length > 0 
        ? rentContracts.map(rawContract => {
            const contract = { ...rawContract };
            contract.contractStatus = normalizeContractStatus(contract.contractStatus);
            contract.status = normalizeActionStatus(contract.status);
            contract.issuanceStatus = normalizeIssuanceStatus(contract.issuanceStatus);
            contract.rentSchedule = normalizeRentSchedule(contract.rentSchedule);

            const statusClass = contract.status === 'Действующий'
              ? 'badge--success'
              : (contract.status === 'Аннулирован' ? 'badge--danger' : 'badge--neutral');
            const contractStatusClass = getContractStatusBadgeClass(contract.contractStatus || 'Новый');
            const issuanceStatusClass = getIssuanceStatusBadgeClass(contract.issuanceStatus || '');
            const vehicleInfo = `${contract.vehicleName} ${contract.vehiclePlate}`.trim();
            const issuanceStatus = contract.issuanceStatus || 'Авто не выдано';
            const days = getContractDays(contract);
            const totalAmount = getContractTotalAmount(contract);

            return `
              <tr style="cursor: pointer;" onclick="window.location.href='contract.html?id=${contract.id}'">
                <td>${formatDateTime(contract.date)}</td>
                <td>${contract.number}</td>
                <td><span class="badge ${contractStatusClass}">${contract.contractStatus || 'Новый'}</span></td>
                <td><span class="badge ${statusClass}">${contract.status}</span></td>
                <td><span class="badge ${issuanceStatusClass}">${issuanceStatus}</span></td>
                <td>${vehicleInfo}</td>
                <td>${contract.driverName}</td>
                <td>${formatDate(contract.startDate)}</td>
                <td>${formatDate(contract.endDate)}</td>
                <td>${contract.rentSchedule}</td>
                <td>${days} ${days === 1 ? 'день' : days < 5 ? 'дня' : 'дней'}</td>
                <td>${formatCurrency(contract.dailyRent)}</td>
                <td>${formatCurrency(totalAmount)}</td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="13" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';

      // Render change history
      const changeHistory = getChangeHistoryByDriverId(driverId);
      document.getElementById('changeHistoryTableBody').innerHTML = changeHistory.length > 0 
        ? changeHistory.map(history => `
          <tr>
            <td>${formatDateTime(history.dateTime)}</td>
            <td>${history.field}</td>
            <td>${history.oldValue || '-'}</td>
            <td>${history.newValue || '-'}</td>
            <td>${history.editorName}</td>
          </tr>
        `).join('')
        : '<tr><td colspan="5" style="text-align: center; color: var(--g-color-text-secondary);">Нет данных</td></tr>';

      // Render finance transactions
      const financeTransactions = getFinanceTransactionsByDriverId(driverId);

      // Function to render finance table
      function renderFinanceTable() {
        const financeTableBody = document.getElementById('financeTableBody');
        if (!financeTableBody) return;

        const dateFrom = document.getElementById('financeDateFrom')?.value;
        const dateTo = document.getElementById('financeDateTo')?.value;

        let filteredTransactions = financeTransactions;

        if (dateFrom || dateTo) {
          filteredTransactions = financeTransactions.filter(t => {
            const transactionDate = new Date(t.date);
            if (dateFrom && transactionDate < new Date(dateFrom)) return false;
            if (dateTo && transactionDate > new Date(dateTo)) return false;
            return true;
          });
        }

        financeTableBody.innerHTML = filteredTransactions.map(t => `
          <tr>
            <td>${formatDate(t.date)}</td>
            <td>${t.section}</td>
            <td>${t.time}</td>
            <td>${t.income > 0 ? formatCurrency(t.income) : '-'}</td>
            <td>${t.expense > 0 ? formatCurrency(t.expense) : '-'}</td>
            <td>${formatCurrency(t.balance)}</td>
            <td>${t.paymentMethod}</td>
            <td>${t.description}</td>
          </tr>
        `).join('');
      }

      // Initial render
      renderFinanceTable();

      // Add event listeners for date filters
      const financeDateFrom = document.getElementById('financeDateFrom');
      const financeDateTo = document.getElementById('financeDateTo');
      if (financeDateFrom) {
        financeDateFrom.addEventListener('change', renderFinanceTable);
      }
      if (financeDateTo) {
        financeDateTo.addEventListener('change', renderFinanceTable);
      }

      document.querySelector('[data-toggle="debt"]').dataset.driverId = driverId;

      initTabs('#driverTabs');
      initModal('#fileModal', '[data-open-modal="#fileModal"]', '[data-close-modal="#fileModal"]');
      initModal('#editDriverModal', '[data-open-modal="#editDriverModal"]', '[data-close-modal="#editDriverModal"]');
      initUIStateToggles();

      // Initialize edit form
      const editForm = document.getElementById('editDriverForm');
      if (editForm) {
        // Helper to format date for input[type="date"]
        const formatDateForInput = (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toISOString().split('T')[0];
        };

        // Populate form with current values
        document.getElementById('editFullName').value = driver.name || '';
        document.getElementById('editStatus').value = driver.status || 'Работает';
        
        // Passport fields
        document.getElementById('editPassportSeries').value = driver.passportSeries || '';
        document.getElementById('editPassportNumber').value = driver.passportNumber || '';
        document.getElementById('editCitizenship').value = driver.citizenship || '';
        document.getElementById('editPassportIssuedBy').value = driver.passportIssuedBy || '';
        document.getElementById('editGender').value = driver.gender || 'Мужской';
        document.getElementById('editPassportIssueDate').value = formatDateForInput(driver.passportIssueDate);
        document.getElementById('editPassportValidUntil').value = formatDateForInput(driver.passportValidUntil);
        document.getElementById('editPassportDepartmentCode').value = driver.passportDepartmentCode || '';
        document.getElementById('editRegistrationAddress').value = driver.registrationAddress || '';
        document.getElementById('editBirthDate').value = formatDateForInput(driver.birthDate);
        document.getElementById('editBirthPlace').value = driver.birthPlace || '';
        document.getElementById('editSnils').value = driver.snils || '';
        
        // License fields
        document.getElementById('editLicenseSeries').value = driver.licenseSeries || '';
        document.getElementById('editLicenseNumber').value = driver.licenseNumber || '';
        document.getElementById('editLicenseExperienceStartDate').value = formatDateForInput(driver.licenseExperienceStartDate);
        document.getElementById('editLicenseIssueDate').value = formatDateForInput(driver.licenseIssueDate);
        document.getElementById('editLicenseCountry').value = driver.licenseCountry || '';
        document.getElementById('editLicenseValidUntil').value = formatDateForInput(driver.licenseValidUntil);
        document.getElementById('editLicenseInvalid').checked = driver.licenseInvalid || false;
        
        // Work conditions
        document.getElementById('editWorkCondition').value = driver.workCondition || '';
        document.getElementById('editWriteOffStartDate').value = formatDateForInput(driver.writeOffStartDate);

        editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          // Get updated values
          const updatedName = document.getElementById('editFullName').value;
          const updatedStatus = document.getElementById('editStatus').value;
          
          // Update driver data
          driver.name = updatedName;
          driver.status = updatedStatus;
          
          // Passport data
          driver.passportSeries = document.getElementById('editPassportSeries').value;
          driver.passportNumber = document.getElementById('editPassportNumber').value;
          driver.citizenship = document.getElementById('editCitizenship').value;
          driver.passportIssuedBy = document.getElementById('editPassportIssuedBy').value;
          driver.gender = document.getElementById('editGender').value;
          driver.passportIssueDate = document.getElementById('editPassportIssueDate').value;
          driver.passportValidUntil = document.getElementById('editPassportValidUntil').value;
          driver.passportDepartmentCode = document.getElementById('editPassportDepartmentCode').value;
          driver.registrationAddress = document.getElementById('editRegistrationAddress').value;
          driver.birthDate = document.getElementById('editBirthDate').value;
          driver.birthPlace = document.getElementById('editBirthPlace').value;
          driver.snils = document.getElementById('editSnils').value;
          
          // License data
          driver.licenseSeries = document.getElementById('editLicenseSeries').value;
          driver.licenseNumber = document.getElementById('editLicenseNumber').value;
          driver.licenseExperienceStartDate = document.getElementById('editLicenseExperienceStartDate').value;
          driver.licenseIssueDate = document.getElementById('editLicenseIssueDate').value;
          driver.licenseCountry = document.getElementById('editLicenseCountry').value;
          driver.licenseValidUntil = document.getElementById('editLicenseValidUntil').value;
          driver.licenseInvalid = document.getElementById('editLicenseInvalid').checked;
          
          // Work conditions
          driver.workCondition = document.getElementById('editWorkCondition').value;
          driver.writeOffStartDate = document.getElementById('editWriteOffStartDate').value;

          // Reload the page to show updated data
          location.reload();
        });
      }

      // Generate PP function for driver fines
      window.generatePPForDriver = function(fineId) {
        const fine = mockData.fines.find(f => f.id === fineId);
        if (!fine) {
          alert('Штраф не найден');
          return;
        }
        alert(`Генерация ПП для штрафа #${fineId}\nДата: ${formatDate(fine.date)}\nАвто: ${fine.plate}\nВодитель: ${fine.driverName}\nСумма: ${formatCurrency(fine.amount)}`);
        // Здесь можно добавить реальную логику генерации ПП
      };
    }
  </script>
</body>
</html>
