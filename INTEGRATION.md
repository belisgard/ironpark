# Интеграция систем

## 1. Создание партнера из ERP

### Цель интеграции
Автоматически создавать партнера и его личный кабинет в B2P-системе на основании данных из ERP, без ручного ввода.

### Источник и направление данных
- Источник мастер-данных: ERP
- Получатель: B2P-система
- Направление: ERP -> B2P

### Логический поток
1. В ERP создается новый партнер (или изменяется существующий профиль партнера).
2. ERP отправляет событие/запрос на интеграционный контур B2P с карточкой партнера.
3. B2P валидирует входные данные и проверяет наличие партнера по внешнему идентификатору ERP (`erpPartnerId`).
4. Если партнер не найден:
   - создается запись партнера в B2P;
   - автоматически создается личный кабинет партнера;
   - назначается базовая роль (например, `partner_admin`) и стартовый статус кабинета.
5. Если партнер уже существует:
   - обновляются разрешенные поля карточки партнера;
   - кабинет не создается повторно.
6. Результат обработки фиксируется в журнале интеграции, ERP получает ответ об успехе/ошибке.

### Ключевые правила
- Идемпотентность: ключом синхронизации является `erpPartnerId`.
- Единственность: один `erpPartnerId` -> один партнер в B2P.
- Повторная отправка того же сообщения не должна создавать дубликаты.
- При неполных/некорректных данных запись не создается, ошибка возвращается в ERP.

### Результат интеграции
- В B2P создан или обновлен партнер.
- Для нового партнера создан личный кабинет.
- Партнер готов к дальнейшим процессам системы (договоры, пользователи, авто, штрафы).

## 2. Получение списка партнеров в ERP

### Цель интеграции
Передавать в ERP актуальный список партнеров, созданных в B2P, для отображения в интерфейсе ERP.

### Источник и направление данных
- Источник данных: B2P-система
- Получатель: ERP
- Направление: ERP <- B2P (по запросу ERP)

### Логический поток
1. Пользователь ERP открывает раздел со списком партнеров.
2. ERP отправляет запрос в B2P на получение списка партнеров.
3. B2P авторизует запрос ERP и формирует выборку партнеров.
4. B2P возвращает список партнеров (с учетом пагинации и фильтров, если они переданы).
5. ERP отображает список в своем интерфейсе.
6. При повторном открытии раздела ERP выполняет повторный запрос для получения актуальных данных.

### Ключевые правила
- Источником истины по карточке партнера является B2P.
- ERP получает только разрешенный набор полей (без чувствительных/служебных данных).
- Для больших объемов данных используется пагинация.
- При недоступности B2P ERP отображает контролируемую ошибку и может повторить запрос.

### Результат интеграции
- ERP отображает актуальный список партнеров из B2P.
- Пользователи ERP видят единый и синхронизированный справочник партнеров.

## 3. Получение списка авто в определенном населенном пункте

### Цель интеграции
Предоставлять клиенту актуальный список автомобилей, доступных в аренде, в выбранном населенном пункте для дальнейшего выбора подходящего варианта.

### Источник и направление данных
- Инициатор запроса: Customer Service
- Источник данных: B2P-система (автопарк/каталог авто)
- Получатель: Customer Service
- Направление: Customer Service <- B2P (по запросу)

### Логический поток
1. Клиент в интерфейсе выбирает населенный пункт.
2. Customer Service отправляет запрос в B2P на получение списка автомобилей по выбранному населенному пункту.
3. B2P валидирует параметры запроса (населенный пункт, дополнительные фильтры).
4. B2P формирует список автомобилей, доступных в аренде в этом населенном пункте.
5. B2P возвращает данные в Customer Service.
6. Customer Service отображает клиенту список авто и позволяет выбрать подходящий вариант.

### Ключевые правила
- В выборку попадают только автомобили, доступные в аренде.
- Список должен быть актуальным на момент запроса.
- Для больших выборок используется пагинация.
- При отсутствии машин возвращается пустой список, не ошибка.
- При некорректном населенном пункте возвращается валидационная ошибка.

### Результат интеграции
- Customer Service получает актуальный список автомобилей, доступных в аренде, по населенному пункту.
- Клиент видит релевантные варианты и может выбрать подходящий автомобиль.

## 4. Создание автомобиля с регистрацией в Яндекс.Такси Адаптере

### Цель интеграции
При создании автомобиля в B2P автоматически отправлять запрос в `Яндекс.Такси Адаптер`, чтобы автомобиль был создан и привязан к выбранной диспетчерской.

### Источник и направление данных
- Инициатор: B2P-система (оператор/пользователь B2P)
- Внешняя система: Яндекс.Такси Адаптер
- Направление: B2P -> Яндекс.Такси Адаптер

### Логический поток
1. Пользователь в B2P заполняет карточку нового автомобиля и выбирает диспетчерскую.
2. B2P валидирует обязательные поля автомобиля и наличие выбранной диспетчерской.
3. B2P отправляет запрос в Яндекс.Такси Адаптер на создание автомобиля с параметром диспетчерской.
4. Яндекс.Такси Адаптер создает автомобиль в указанной диспетчерской и возвращает результат.
5. При успешном ответе B2P сохраняет автомобиль у себя, включая внешние идентификаторы и ссылку на диспетчерскую.
6. B2P показывает пользователю статус успешного создания и привязки.

### Ключевые правила
- Создание автомобиля в B2P выполняется только при успешном ответе от Яндекс.Такси Адаптера.
- Автомобиль должен быть привязан к одной выбранной диспетчерской на этапе создания.
- Идемпотентность запроса должна исключать создание дублей при повторной отправке.
- При ошибке внешней системы B2P не фиксирует автомобиль как созданный и возвращает понятную ошибку пользователю.
- В B2P хранится связь: `carId` <-> `externalCarId` <-> `dispatcherId`.

### Результат интеграции
- Автомобиль создан в Яндекс.Такси Адаптере в выбранной диспетчерской.
- В B2P создана карточка автомобиля с привязкой к этой диспетчерской и внешним идентификатором.

## 5. Получение списка штрафов через API МВД

### Цель интеграции
Получать в B2P список штрафов, закрепленных за конкретным автомобилем, по параметру номера автомобиля.

### Источник и направление данных
- Инициатор: B2P-система (по запросу пользователя или фоновому обновлению)
- Внешняя система: API МВД
- Направление: B2P -> API МВД -> B2P

### Логический поток
1. В B2P передается параметр поиска: номер автомобиля (`plate`).
2. B2P валидирует формат номера автомобиля.
3. B2P отправляет запрос в API МВД с параметром номера автомобиля.
4. API МВД возвращает список штрафов, зарегистрированных за этим автомобилем.
5. B2P принимает и нормализует данные штрафов под внутренний формат.
6. B2P отображает пользователю список штрафов по выбранному автомобилю.

### Ключевые правила
- Поиск выполняется строго по номеру автомобиля.
- В ответ попадают только штрафы, относящиеся к указанному номеру.
- При отсутствии штрафов возвращается пустой список, не ошибка.
- Ошибки внешнего API фиксируются в журнале интеграции и возвращаются в контролируемом виде.
- Для повторных запросов может использоваться кэш с коротким TTL (если это допустимо бизнес-правилами).

### Результат интеграции
- B2P получает актуальный список штрафов по номеру автомобиля из API МВД.
- Пользователь B2P видит все связанные с автомобилем штрафы в едином интерфейсе.

## 6. Выгрузка данных водителя в B2P после выбора арендованного автомобиля

### Цель интеграции
После выбора водителем арендованного автомобиля передать данные этого водителя в B2P и привязать его к партнеру, которому принадлежит выбранный автомобиль.

### Источник и направление данных
- Инициатор: внешняя система оформления аренды / Customer Service
- Получатель: B2P-система
- Направление: внешняя система -> B2P

### Логический поток
1. Водитель выбирает автомобиль для аренды.
2. Внешняя система определяет партнера, к которому привязан выбранный автомобиль.
3. Внешняя система отправляет в B2P данные водителя вместе с идентификаторами автомобиля и партнера.
4. B2P валидирует данные и проверяет существование партнера и автомобиля.
5. Если водитель новый, B2P создает карточку водителя; если уже существует, обновляет разрешенные поля.
6. B2P создает/обновляет привязку водителя к партнеру и выбранному автомобилю.
7. Данные водителя становятся доступными в реестре водителей партнера в B2P.

### Ключевые правила
- Передача выполняется только для автомобиля, который уже привязан к конкретному партнеру.
- Ключ идемпотентности: внешний идентификатор водителя (`externalDriverId`) или связка (`externalDriverId` + `partnerId`).
- Повторная отправка не должна создавать дубль водителя.
- При отсутствии партнера или автомобиля в B2P запрос отклоняется с контролируемой ошибкой.
- Изменяются только разрешенные поля водителя; чувствительные поля обновляются по отдельным правилам доступа.

### Результат интеграции
- В B2P создана или обновлена карточка водителя.
- Водитель привязан к нужному партнеру и выбранному арендованному автомобилю.
- Партнер видит водителя в своем интерфейсе B2P и может работать с ним дальше (договор, штрафы, учет).

## 7. Интеграция с почтовым сервисом для авторизации по e-mail

### Цель интеграции
Обеспечить авторизацию пользователей B2P по e-mail через отправку одноразового кода или ссылки подтверждения.

### Источник и направление данных
- Инициатор: B2P-система (страница входа)
- Внешняя система: почтовый сервис
- Направление: B2P -> почтовый сервис -> пользователь -> B2P

### Логический поток
1. Пользователь вводит e-mail на странице авторизации B2P.
2. B2P проверяет, что e-mail зарегистрирован и активен.
3. B2P генерирует одноразовый код (или magic link) с ограниченным временем жизни.
4. B2P отправляет письмо через почтовый сервис.
5. Пользователь вводит код (или переходит по ссылке из письма).
6. B2P валидирует токен/код и создает авторизованную сессию.

### Ключевые правила
- Одноразовый код/ссылка имеет TTL и ограничение по количеству попыток ввода.
- Повторная отправка письма ограничивается rate limit.
- При несуществующем e-mail возвращается нейтральный ответ без раскрытия данных учетной записи.
- Все события авторизации (отправка, успешный вход, неуспешная проверка) логируются.
- Доставка писем должна поддерживать повторную отправку при временных ошибках почтового сервиса.

### Результат интеграции
- Пользователь получает письмо для входа по e-mail.
- После успешной проверки кода/ссылки пользователь авторизуется в B2P.

## 8. Блокировка автомобиля в диспетчерской

### Цель интеграции
Автоматически блокировать автомобиль в диспетчерской, если нарушены условия договора: просрочен возврат автомобиля или превышен лимит суммы штрафов.

### Источник и направление данных
- Инициатор: B2P-система (мониторинг договоров и штрафов)
- Внешняя система: диспетчерская (через интеграционный адаптер)
- Направление: B2P -> диспетчерская

### Логический поток
1. B2P контролирует состояние договора аренды и накопленную сумму штрафов по автомобилю/водителю.
2. Если дата возврата по договору просрочена или сумма штрафов превышает допустимый лимит, B2P формирует событие блокировки.
3. B2P отправляет запрос в диспетчерскую на блокировку автомобиля.
4. Диспетчерская блокирует автомобиль и возвращает статус операции.
5. B2P сохраняет результат блокировки и отображает статус в карточке автомобиля/договора.

### Ключевые правила
- Основания блокировки:
  - просрочка возврата автомобиля по договору;
  - превышение лимита суммы штрафов.
- Запрос на блокировку должен быть идемпотентным, чтобы повторная отправка не вызывала ошибок и дублей операций.
- При недоступности диспетчерской запрос ставится в повторную обработку до получения финального статуса.
- Каждая операция блокировки журналируется (причина, время, инициатор, внешний статус).
- После успешной блокировки автомобиль считается недоступным для выдачи/аренды в B2P.

### Результат интеграции
- Автомобиль блокируется в диспетчерской при наступлении условий блокировки.
- Статус блокировки синхронизируется в B2P и учитывается в бизнес-процессах аренды.
