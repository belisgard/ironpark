# Бизнес-процесс: Аренда автомобиля от выбора до выдачи механику

## Версия документа: 1.0
**Дата создания:** 2025-01-XX  
**Автор:** Анализ на основе прототипа B2P платформы

---

## Оглавление

1. [Общее описание процесса](#общее-описание-процесса)
2. [Этап 1: Выбор водителем арендного автомобиля](#этап-1-выбор-водителем-арендного-автомобиля)
3. [Этап 2: Формирование договора партнёром](#этап-2-формирование-договора-партнёром)
4. [Этап 3: Загрузка паспортных данных водителя](#этап-3-загрузка-паспортных-данных-водителя)
5. [Этап 4: Загрузка скана договора](#этап-4-загрузка-скана-договора)
6. [Этап 5: Подписание договора](#этап-5-подписание-договора)
7. [Этап 6: Загрузка оригинала подписанного договора](#этап-6-загрузка-оригинала-подписанного-договора)
8. [Этап 7: Отправка механику для выдачи авто](#этап-7-отправка-механику-для-выдачи-авто)
9. [Этап 8: Процесс выдачи автомобиля механиком](#этап-8-процесс-выдачи-автомобиля-механиком)
10. [Схема статусов договора](#схема-статусов-договора)
11. [Схема статусов выдачи](#схема-статусов-выдачи)
12. [Кейсы использования](#кейсы-использования)
13. [Обработка ошибок и отклонений](#обработка-ошибок-и-отклонений)

---

## Общее описание процесса

Бизнес-процесс описывает полный цикл аренды автомобиля от момента выбора водителем арендного транспортного средства до фактической выдачи автомобиля механиком. Процесс включает следующие ключевые этапы:

1. **Выбор водителем арендного авто** (`car-selection/index.html`)
2. **Формирование договора партнёром** (`partner/contracts.html`)
3. **Загрузка паспортных данных** (редактирование водителя в `partner/driver.html`)
4. **Загрузка скана договора** (`partner/contract.html`)
5. **Подписание договора** (изменение статуса на "требуется подписание" → "подписанный скан загружен")
6. **Загрузка оригинала подписанного договора** (`partner/contract.html`)
7. **Отправка механику** (изменение статуса выдачи на "авто выдано")
8. **Выдача автомобиля механиком** (`mechanic/issue.html`)

---

## Этап 1: Выбор водителем арендного автомобиля

### Описание
Водитель выбирает арендное транспортное средство из доступного парка через интерфейс выбора авто.

### Интерфейс
- **Страница:** `car-selection/index.html`
- **Переключатель:** "Собственное авто" / "Арендное авто"

### Процесс для "Арендное авто"

1. **Выбор автомобиля из списка**
   - Отображается выпадающий список: "Марка Модель - Госномер"
   - Пример: "Changan ALSVIN - K477MB122"
   - Список формируется из доступных автомобилей с статусом "Свободен"

2. **Автоматическое заполнение данных**
   - **Пробег** — автоматически заполняется из данных автомобиля (readonly)
   - **Стоимость аренды в сутки** — автоматически отображается из договора или устанавливается по умолчанию

3. **Отображение информации**
   - Показывается пробег: "82907 км" (readonly)
   - Показывается стоимость аренды: "2 550 ₽ / сутки"

4. **Подтверждение выбора**
   - Нажатие кнопки "Продолжить"
   - Данные сохраняются (в прототипе — alert с подтверждением)

### Данные, передаваемые далее
- ID выбранного автомобиля
- Госномер автомобиля
- Марка и модель
- Пробег
- Стоимость аренды в сутки
- Дата выбора

---

## Этап 2: Формирование договора партнёром

### Описание
Партнёр (администратор) создаёт договор аренды на основе выбранного водителем автомобиля.

### Интерфейс
- **Страница:** `partner/contracts.html`
- **Действие:** Кнопка "+ Добавить договор"

### Процесс

1. **Заполнение данных договора**
   - **Номер договора** (обязательно): "ДР-2024-001"
   - **Водитель** (обязательно): выбор из списка водителей
   - **Транспортное средство** (обязательно): выбор из списка ТС
   - **Начало действия** (обязательно): дата начала
   - **Окончание действия** (опционально): дата окончания
   - **Стоимость аренды в сутки** (обязательно): сумма

2. **Создание договора**
   - При нажатии "Добавить" создаётся новый договор
   - **Начальный статус договора:** `contractStatus: 'новый'`
   - **Статус действия:** `status: 'действующий'` (если дата окончания не указана или в будущем)
   - **Статус выдачи:** `issuanceStatus: null`

3. **Автоматические поля**
   - Дата создания: текущая дата/время
   - Автоматическое заполнение названия ТС из выбранного автомобиля
   - Автоматическое заполнение имени водителя из выбранного водителя

### Результат
Договор создан со статусом **"новый"** и отображается в списке договоров.

---

## Этап 3: Загрузка паспортных данных водителя

### Описание
Партнёр заполняет или проверяет паспортные данные водителя, необходимые для договора.

### Интерфейс
- **Страница:** `partner/driver.html`
- **Вкладка:** "Основное" → кнопка "Редактировать"

### Процесс

1. **Проверка/заполнение паспортных данных**
   - **Серия/номер паспорта** (без пробелов)
   - **Гражданство**
   - **Кем выдан**
   - **Дата выдачи**
   - **Действителен до**
   - **Код подразделения**
   - **Дата рождения**
   - **Место рождения**
   - **Адрес регистрации**

2. **Проверка СНИЛС**
   - Номер СНИЛС

3. **Проверка водительских прав**
   - Серия/номер прав
   - Дата выдачи
   - Действителен до
   - Дата начала стажа

4. **Изменение статуса договора**
   - После заполнения всех обязательных паспортных данных
   - Партнёр вручную или автоматически меняет статус договора на **"требуется заполнение паспорта"** → **"требуется подписание"**

### Важно
- Заполнение паспортных данных может быть выполнено до или после создания договора
- Статус договора не меняется автоматически, требуется ручное изменение партнёром

---

## Этап 4: Загрузка скана договора

### Описание
Партнёр загружает отсканированный или сфотографированный экземпляр договора до подписания.

### Интерфейс
- **Страница:** `partner/contract.html`
- **Действие:** Кнопка "Загрузить скан договора"

### Процесс

1. **Выбор файла**
   - Поддерживаемые форматы: изображения (JPG, PNG, GIF) и PDF
   - Максимальный размер: 10 МБ

2. **Загрузка**
   - Файл читается через FileReader как Data URL
   - Сохраняется в объекте договора: `contract.scan = dataUrl`
   - Сохраняется тип файла: `contract.scanType = 'image' | 'pdf'`

3. **Отображение**
   - Изображения отображаются через `<img>` с максимальной высотой 500px
   - PDF отображается через `<iframe>` с высотой 600px
   - Для PDF добавляется ссылка "Открыть скан договора в новом окне"

4. **Возможность удаления**
   - Кнопка "Удалить скан" удаляет загруженный файл

### Важно
- Скан может быть загружен на любом этапе до подписания
- Загрузка скана не меняет статус договора автоматически

---

## Этап 5: Подписание договора

### Описание
Процесс подписания договора водителем и партнёром. Подписанный документ загружается в систему.

### Интерфейс
- **Страница:** `partner/contract.html`
- **Действие:** Редактирование статуса договора через модальное окно "Редактирование договора"

### Процесс

1. **Подготовка к подписанию**
   - Статус договора: **"требуется подписание"**
   - Договор распечатывается через кнопку "Распечатать" (используется `window.print()`)

2. **Подписание**
   - Водитель и партнёр подписывают печатный экземпляр договора

3. **Загрузка подписанного скана**
   - Партнёр загружает отсканированный подписанный договор через "Загрузить скан договора"
   - Поддерживаются форматы: изображения (JPG, PNG, GIF) и PDF
   - Максимальный размер: 10 МБ

4. **Изменение статуса**
   - Партнёр вручную меняет статус договора на **"подписанный скан загружен"**
   - Через модальное окно "Редактирование договора" → поле "Статус договора"

### Результат
- Статус договора: **"подписанный скан загружен"**
- Подписанный скан загружен в систему
- Договор готов к отправке механику

---

## Этап 6: Загрузка оригинала подписанного договора

### Описание
После подписания оригинала договора, его также загружают в систему (опционально, может быть объединено с этапом 5).

### Процесс

1. **Физическое подписание**
   - Водитель и партнёр подписывают оригинальный бумажный экземпляр

2. **Загрузка оригинала**
   - Партнёр сканирует/фотографирует подписанный оригинал
   - Загружает через "Загрузить скан договора" на странице договора
   - Файл сохраняется как `contract.scan` с типом `'image'` или `'pdf'`

### Важно
- Оригинал и скан могут быть загружены в один файл
- Статус договора при этом уже должен быть **"подписанный скан загружен"**

---

## Этап 7: Отправка механику для выдачи авто

### Описание
Партнёр изменяет статус выдачи на "авто выдано", что создаёт задачу для механика.

### Интерфейс
- **Страница:** `partner/contract.html`
- **Действие:** Редактирование через модальное окно "Редактирование договора" → поле "Выдача"

### Процесс

1. **Проверка готовности**
   - Статус договора: **"подписанный скан загружен"**
   - Подписанный скан загружен

2. **Изменение статуса выдачи**
   - Партнёр выбирает в поле "Выдача": **"Авто выдано"**
   - Сохраняет изменения

3. **Создание задачи для механика**
   - В системе создаётся запись о необходимости выдачи авто
   - Задача появляется в интерфейсе механика (`mechanic/home.html` → вкладка "Выдача")

### Данные задачи для механика
- **Автомобиль:** госномер и модель
- **Водитель:** ФИО водителя
- **Место:** указывается партнёром или автоматически
- **Время:** указывается партнёром или автоматически
- **Ссылка на договор:** доступ к информации о договоре

### Результат
- Статус выдачи: `issuanceStatus: 'авто выдано'`
- Задача появилась в интерфейсе механика

---

## Этап 8: Процесс выдачи автомобиля механиком

### Описание
Механик выполняет процедуру выдачи автомобиля водителю по пошаговому процессу.

### Интерфейс
- **Страница:** `mechanic/home.html` → вкладка "Выдача" → кнопка "Открыть"
- **Процесс:** `mechanic/issue.html`

### Шаг 1: Авто и водитель

1. **Выбор автомобиля**
   - Выпадающий список с доступными автомобилями для выдачи
   - Отображается: "А123БВ777 - Toyota Camry"

2. **Выбор водителя**
   - Выпадающий список с водителями
   - Отображается: "Иванов Иван Иванович"

3. **Переход к следующему шагу**
   - Кнопка "Далее"

### Шаг 2: Фотофиксация

1. **Загрузка фото**
   - Минимум 1 фото (можно больше)
   - Форматы: изображения (через `accept="image/*"`)

2. **Предпросмотр**
   - Отображается сетка 3x3 с превью загруженных фотографий
   - Каждое фото показывается в миниатюре (100px высота)

3. **Валидация**
   - Кнопка "Далее" активна только при наличии хотя бы 1 фото

### Шаг 3: Чек-лист

1. **Проверка комплектности и состояния**
   - ☑ Комплектность полная
   - ☑ Нет повреждений
   - ☑ Техническое состояние в норме

2. **Обязательные проверки**
   - Все три чекбокса должны быть отмечены для продолжения

3. **Переход к подписи**
   - Кнопка "Далее" активна только при отмеченных всех трёх чекбоксах

### Шаг 4: Подпись

1. **Получение подписи водителя**
   - Canvas для рисования подписи водителя
   - Поддержка мыши и touch-событий
   - Размер: 100% ширины, 200px высоты

2. **Действия**
   - Кнопка "Очистить" для сброса подписи
   - Кнопка "Далее" активна только при наличии подписи

### Шаг 5: Завершение

1. **Проверка всех данных**
   - Отображается экран с просьбой проверить все данные

2. **Финализация**
   - Кнопка "Завершить выдачу" (активна только при выполнении всех предыдущих шагов)

3. **Результат**
   - Отображается экран успеха: "Выдача завершена"
   - Кнопка "Назад к задачам" возвращает к списку задач

### Данные, сохраняемые при выдаче

- Дата и время выдачи
- ID автомобиля
- ID водителя
- Фотографии (массив файлов)
- Результаты чек-листа (все три пункта выполнены)
- Подпись водителя (изображение canvas)
- Механик, выполнивший выдачу

---

## Схема статусов договора

### Статусы договора (`contractStatus`)

1. **"новый"** (синий badge)
   - Начальный статус при создании договора
   - Договор создан, но требует дальнейших действий

2. **"требуется заполнение паспорта"** (жёлтый badge)
   - Требуется заполнение или проверка паспортных данных водителя
   - Переход: партнёр изменяет статус вручную

3. **"требуется подписание"** (жёлтый badge)
   - Договор готов к подписанию
   - Все данные заполнены, требуется подпись водителя и партнёра

4. **"подписанный скан загружен"** (зелёный badge)
   - Договор подписан и подписанный скан загружен в систему
   - Договор готов к выдаче авто

### Статус действия (`status`)

- **"действующий"** (зелёный badge) — договор активен
- **"истекший"** (серый badge) — договор завершён (дата окончания в прошлом)

### Статус выдачи (`issuanceStatus`)

- **`null`** или **"Не указано"** — авто не выдано
- **"авто выдано"** (зелёный badge) — авто выдано водителю
- **"авто принято"** (жёлтый badge) — авто принято обратно от водителя

### Визуализация статусов договора

На странице договора (`partner/contract.html`) отображается список всех возможных статусов с индикацией текущего:
- Текущий статус выделяется цветным фоном и жирным шрифтом
- Рядом с текущим статусом отображается цветная точка (зелёная для активного, серая для неактивных)

---

## Схема статусов выдачи

### Процесс изменения статусов выдачи

```
null → "авто выдано" → "авто принято"
```

1. **Начальное состояние**: `issuanceStatus: null`
   - Авто ещё не выдано

2. **После создания задачи для механика**: `issuanceStatus: "авто выдано"`
   - Партнёр устанавливает статус через редактирование договора
   - Задача появляется в интерфейсе механика

3. **После фактической выдачи механиком**:
   - Статус остаётся **"авто выдано"**
   - Механик завершает процесс выдачи через `mechanic/issue.html`

4. **После приёмки авто обратно**: `issuanceStatus: "авто принято"`
   - Механик выполняет приёмку через `mechanic/return.html`
   - Партнёр может вручную изменить статус на "авто принято"

---

## Кейсы использования

### Кейс 1: Успешный полный процесс

**Сценарий:**
1. Водитель выбирает арендное авто через `car-selection/index.html`
2. Партнёр создаёт договор со статусом "новый"
3. Партнёр заполняет паспортные данные водителя
4. Партнёр меняет статус на "требуется подписание"
5. Партнёр загружает скан договора (до подписания)
6. Партнёр распечатывает договор
7. Водитель и партнёр подписывают договор
8. Партнёр загружает подписанный скан
9. Партнёр меняет статус на "подписанный скан загружен"
10. Партнёр устанавливает статус выдачи на "авто выдано"
11. Задача появляется у механика
12. Механик выполняет выдачу (фото, чек-лист, подпись)
13. Выдача завершена

**Результат:** Автомобиль успешно выдан водителю.

---

### Кейс 2: Договор создан без предварительного выбора водителем

**Сценарий:**
1. Партнёр напрямую создаёт договор через `partner/contracts.html`
2. Выбирает водителя из списка
3. Выбирает доступное ТС
4. Остальные этапы выполняются как в Кейсе 1

**Особенность:** Этап выбора водителем арендного авто пропущен, но это допустимо.

---

### Кейс 3: Загрузка скана до подписания

**Сценарий:**
1. Договор создан со статусом "новый"
2. Партнёр загружает скан договора (пустой, без подписей)
3. Партнёр распечатывает договор
4. Договор подписывается
5. Партнёр загружает новый скан (подписанный) поверх старого

**Особенность:** Возможна замена скана договора.

---

### Кейс 4: Паспортные данные заполнены заранее

**Сценарий:**
1. Паспортные данные водителя уже заполнены в системе
2. Партнёр создаёт договор
3. Партнёр сразу меняет статус на "требуется подписание" (пропуская "требуется заполнение паспорта")

**Особенность:** Этап заполнения паспорта может быть пропущен, если данные уже есть.

---

### Кейс 5: Договор с собственным авто водителя

**Сценарий:**
1. На этапе выбора авто водитель выбирает "Собственное авто"
2. Заполняет данные из СТС (регистрационный знак, год, марка, цвет, модель)
3. Партнёр создаёт договор, но не привязывает к ТС из парка
4. Остальные этапы выполняются аналогично

**Особенность:** Для собственного авто не требуется статус выдачи "авто выдано".

---

### Кейс 6: Досрочное завершение договора

**Сценарий:**
1. Договор действующий, статус выдачи "авто выдано"
2. Водитель возвращает авто
3. Механик выполняет приёмку через `mechanic/return.html`
4. Партнёр изменяет статус выдачи на "авто принято"
5. Партнёр может изменить дату окончания действия договора

**Результат:** Договор завершён досрочно, авто принято обратно.

---

### Кейс 7: Отклонение при выдаче (механик обнаружил проблему)

**Сценарий:**
1. Партнёр установил статус выдачи "авто выдано"
2. Задача появилась у механика
3. Механик начинает процесс выдачи
4. На шаге "Чек-лист" механик обнаруживает повреждение или некомплект
5. Механик не может отметить "Нет повреждений" или "Комплектность полная"
6. Процесс выдачи блокируется

**Действия:**
- Механик возвращается к шагу выбора авто
- Механик сообщает партнёру о проблеме
- Партнёр может отменить задачу (изменить статус выдачи обратно на `null`)
- Партнёр решает проблему (ремонт, комплектация)
- После решения проблемы процесс повторяется

---

### Кейс 8: Приёмка авто с повреждениями

**Сценарий:**
1. Водитель возвращает авто
2. Механик выполняет приёмку через `mechanic/return.html`
3. Шаг 3: Механик отмечает чекбоксы:
   - ☑ Поврежден
   - ☑ Некомплект (если применимо)
   - ☑ Утери документов (если применимо)
4. Механик загружает минимум 3 фото повреждений
5. Механик добавляет комментарий с описанием

**Результат:**
- Запись о приёмке создана
- Партнёр видит информацию о повреждениях/некомплекте
- Может быть создан заказ-наряд на ремонт

---

### Кейс 9: Повторная выдача (продление договора)

**Сценарий:**
1. Договор завершён, авто принято
2. Партнёр продлевает договор (изменяет дату окончания)
3. Партнёр устанавливает статус выдачи на "авто выдано"
4. Задача появляется у механика
5. Механик выполняет выдачу заново

**Особенность:** Для продления может не требоваться повторное подписание, если это оговорено в договоре.

---

### Кейс 10: Ошибка при загрузке скана

**Сценарий:**
1. Партнёр пытается загрузить скан договора
2. Файл слишком большой (>10 МБ) или неподдерживаемый формат
3. Система показывает ошибку: "Размер файла не должен превышать 10 МБ" или "Пожалуйста, выберите изображение (JPG, PNG, GIF) или PDF файл"
4. Партнёр загружает корректный файл

**Обработка:** Валидация файла выполняется на клиенте перед загрузкой.

---

## Обработка ошибок и отклонений

### Ошибки на этапе создания договора

**Проблема:** Водитель или ТС не выбраны  
**Решение:** Система показывает alert "Ошибка: не найден водитель или ТС"

**Проблема:** Дата окончания в прошлом  
**Решение:** Статус действия автоматически устанавливается "истекший"

---

### Ошибки на этапе загрузки скана

**Проблема:** Файл больше 10 МБ  
**Решение:** Alert "Размер файла не должен превышать 10 МБ", файл не загружается

**Проблема:** Неподдерживаемый формат  
**Решение:** Alert "Пожалуйста, выберите изображение (JPG, PNG, GIF) или PDF файл"

**Проблема:** Ошибка чтения файла  
**Решение:** Alert "Ошибка при загрузке файла"

---

### Ошибки на этапе выдачи

**Проблема:** Фото не загружены  
**Решение:** Кнопка "Далее" на шаге 2 неактивна

**Проблема:** Чек-лист не пройден  
**Решение:** Кнопка "Далее" на шаге 3 неактивна, все три чекбокса должны быть отмечены

**Проблема:** Подпись отсутствует  
**Решение:** Кнопка "Далее" на шаге 4 неактивна

---

### Отклонения процесса

**Отмена задачи выдачи:**
- Партнёр может изменить статус выдачи с "авто выдано" обратно на `null`
- Задача исчезает из интерфейса механика

**Несоответствие данных:**
- Если на этапе выдачи механик выбирает другого водителя или авто, система должна предупредить или заблокировать несоответствие

**Досрочное завершение договора:**
- При изменении даты окончания на прошедшую дату, статус действия меняется на "истекший"

---

## Диаграмма процесса (текстовая)

```
[Водитель выбирает арендное авто]
         ↓
[Партнёр создаёт договор: статус "новый"]
         ↓
[Партнёр заполняет паспортные данные]
         ↓
[Партнёр: статус → "требуется подписание"]
         ↓
[Партнёр загружает скан договора (опционально)]
         ↓
[Партнёр распечатывает договор]
         ↓
[Водитель и партнёр подписывают договор]
         ↓
[Партнёр загружает подписанный скан]
         ↓
[Партнёр: статус → "подписанный скан загружен"]
         ↓
[Партнёр: статус выдачи → "авто выдано"]
         ↓
[Задача появляется у механика]
         ↓
[Механик: Шаг 1 - Выбор авто/водителя]
         ↓
[Механик: Шаг 2 - Фотофиксация (минимум 1 фото)]
         ↓
[Механик: Шаг 3 - Чек-лист (все 3 пункта отмечены)]
         ↓
[Механик: Шаг 4 - Подпись водителя]
         ↓
[Механик: Шаг 5 - Завершение выдачи]
         ↓
[Выдача завершена ✅]
```

---

## Дополнительные замечания

### Автоматизация

В текущем прототипе большинство переходов между статусами выполняются вручную партнёром. В реальной системе возможна автоматизация:

- Автоматическая смена статуса на "требуется подписание" после заполнения всех обязательных полей
- Автоматическое создание задачи для механика при установке статуса "авто выдано"
- Уведомления водителю и механику о смене статусов

### Интеграции

Процесс может быть интегрирован с:

- Системой электронного документооборота для подписания
- SMS/Email уведомлениями
- Системой учёта времени и местоположения
- Камерами для автоматической фотофиксации

### Безопасность

- Все действия должны логироваться с указанием пользователя и времени
- Загрузка файлов должна проходить валидацию на сервере
- Доступ к договорам должен контролироваться правами доступа

---

## Заключение

Данный документ описывает полный бизнес-процесс аренды автомобиля на основе анализа HTML-прототипа B2P платформы. Процесс включает 8 основных этапов от выбора водителем арендного авто до фактической выдачи механиком.

Процесс поддерживает различные сценарии использования, включая обработку ошибок и отклонений. Все статусы и переходы четко определены и могут быть реализованы в полноценной системе на основе данного прототипа.
