<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Выдача авто - Механик</title>
  <link rel="stylesheet" href="../assets/css/gravity-theme.css">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
  <div class="header">
    <div class="header__logo" onclick="window.location.href='../index.html'">B2P Платформа</div>
    <button class="btn btn--normal" onclick="window.location.href='../index.html'">Выйти</button>
  </div>

  <main class="main-content" style="max-width: 600px; margin: 0 auto; padding: 24px;">
    <div style="margin-bottom: 24px;">
      <a href="home.html" style="color: var(--g-color-text-link); text-decoration: none;">← Назад к задачам</a>
    </div>

    <h1 style="margin-bottom: 32px;">Выдача авто</h1>

    <!-- Progress Steps -->
    <div style="display: flex; justify-content: space-between; margin-bottom: 32px; position: relative;">
      <div style="flex: 1; text-align: center;">
        <div class="badge badge--info" id="step1" style="width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">1</div>
        <div style="font-size: var(--g-font-size-sm); margin-top: 8px;">Авто/Водитель</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div class="badge badge--neutral" id="step2" style="width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">2</div>
        <div style="font-size: var(--g-font-size-sm); margin-top: 8px;">Фото</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div class="badge badge--neutral" id="step3" style="width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">3</div>
        <div style="font-size: var(--g-font-size-sm); margin-top: 8px;">Чек-лист</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div class="badge badge--neutral" id="step4" style="width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">4</div>
        <div style="font-size: var(--g-font-size-sm); margin-top: 8px;">Подпись</div>
      </div>
      <div style="flex: 1; text-align: center;">
        <div class="badge badge--neutral" id="step5" style="width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">5</div>
        <div style="font-size: var(--g-font-size-sm); margin-top: 8px;">Завершение</div>
      </div>
    </div>

    <!-- Step 1 -->
    <div class="card" id="step1Content">
      <h3 style="margin-bottom: 16px;">Шаг 1: Авто и водитель</h3>
      <div class="form-group">
        <label class="form-label">Автомобиль</label>
        <select class="form-select" id="carSelect" onchange="loadPreviousComment()">
          <option value="">Выберите авто</option>
          <option value="А123БВ777" data-plate="А123БВ777">А123БВ777 - Toyota Camry</option>
          <option value="Е345КЛ777" data-plate="Е345КЛ777">Е345КЛ777 - Skoda Octavia</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Водитель</label>
        <select class="form-select" id="driverSelect">
          <option value="">Выберите водителя</option>
          <option value="1">Иванов Иван Иванович</option>
          <option value="2">Козлов Константин Константинович</option>
        </select>
      </div>
      <div id="previousCommentSection" style="display: none; margin-top: 16px; padding: 16px; background: var(--g-color-base-generic); border-radius: 8px;">
        <div style="font-size: var(--g-font-size-sm); color: var(--g-color-text-secondary); margin-bottom: 8px;">Предыдущий комментарий по данному автомобилю:</div>
        <div id="previousCommentText" style="font-size: var(--g-font-size-md); color: var(--g-color-text-primary);"></div>
      </div>
      <button class="btn btn--action" onclick="goToStep(2)" style="width: 100%; margin-top: 16px;">Далее</button>
    </div>

    <!-- Step 2 -->
    <div class="card" id="step2Content" style="display: none;">
      <h3 style="margin-bottom: 16px;">Шаг 2: Фотофиксация</h3>
      <div class="form-group">
        <label class="form-label">Фото (минимум 1)</label>
        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn btn--action" onclick="openCamera()" style="flex: 1;">Сделать фото</button>
          <button type="button" class="btn btn--normal" onclick="openGallery()" style="flex: 1;">Из галереи</button>
        </div>
        <input type="file" id="cameraPhotoInput" accept="image/*" capture="environment" onchange="handleCameraPhoto(event)" style="display: none;">
        <input type="file" id="photoInput" multiple accept="image/*" onchange="handlePhotoUpload(event)" style="display: none;">
        <div style="font-size: var(--g-font-size-sm); color: var(--g-color-text-secondary); margin-top: 8px;">
          На мобильном устройстве кнопка "Сделать фото" открывает камеру.
        </div>
      </div>
      <div id="photoPreview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;"></div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="btn btn--normal" onclick="goToStep(1)" style="flex: 1;">Назад</button>
        <button class="btn btn--action" onclick="goToStep(3)" id="step2Next" style="flex: 1;" disabled>Далее</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="card" id="step3Content" style="display: none;">
      <h3 style="margin-bottom: 16px;">Шаг 3: Чек-лист</h3>
      <div class="form-group">
        <label class="form-label">Пробег<span class="required" style="color: #FF3D00; margin-left: 2px;">*</span></label>
        <input 
          type="text" 
          class="form-input" 
          id="mileageInput" 
          placeholder="Введите пробег в км"
        >
      </div>
      <div class="form-group">
        <button type="button" class="btn btn--normal" onclick="showCompletenessModal()" style="width: 100%;">
          Комплектность
        </button>
      </div>
      <div class="form-group">
        <label class="form-label">Комментарий</label>
        <textarea class="form-input" id="commentInput" rows="4" placeholder="Опишите повреждения или состояние"></textarea>
      </div>
      <div class="form-group" style="margin-top: 16px;">
        <button type="button" class="btn btn--normal" onclick="showCommentsModal()" style="width: 100%;">
          Показать комментарий
        </button>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="btn btn--normal" onclick="goToStep(2)" style="flex: 1;">Назад</button>
        <button class="btn btn--action" onclick="goToStep(4)" id="step3Next" style="flex: 1;">Далее</button>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="card" id="step4Content" style="display: none;">
      <h3 style="margin-bottom: 16px;">Шаг 4: Подпись</h3>
      <canvas id="signatureCanvas" height="220" style="width: 100%; height: 220px; display: block; border: 1px solid var(--g-color-line-generic); border-radius: var(--g-border-radius-md); cursor: crosshair; touch-action: none; box-sizing: border-box;"></canvas>
      <button class="btn btn--normal" onclick="clearSignature()" style="width: 100%; margin-top: 12px;">Очистить</button>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="btn btn--normal" onclick="goToStep(3)" style="flex: 1;">Назад</button>
        <button class="btn btn--action" onclick="goToStep(5)" id="step4Next" style="flex: 1;" disabled>Далее</button>
      </div>
    </div>

    <!-- Step 5 -->
    <div class="card" id="step5Content" style="display: none;">
      <h3 style="margin-bottom: 16px;">Шаг 5: Завершение</h3>
      <p style="margin-bottom: 24px; color: var(--g-color-text-secondary);">
        Проверьте все данные перед завершением выдачи
      </p>
      <button class="btn btn--action" id="completeBtn" onclick="completeIssue()" style="width: 100%;" disabled>Завершить выдачу</button>
      <button class="btn btn--normal" onclick="goToStep(4)" style="width: 100%; margin-top: 12px;">Назад</button>
    </div>

    <!-- Success Screen -->
    <div class="card" id="successScreen" style="display: none; text-align: center;">
      <h2 style="margin-bottom: 16px; color: var(--g-color-base-success);">Выдача завершена</h2>
      <p style="margin-bottom: 24px; color: var(--g-color-text-secondary);">
        Автомобиль успешно выдан
      </p>
      <a href="home.html?tab=issue" class="btn btn--action" style="width: 100%; text-align: center; display: block;">Назад к задачам</a>
    </div>
  </main>

  <!-- Comments Modal -->
  <div class="modal" id="commentsModal">
    <div class="modal__content">
      <div class="modal__header">
        <h3 class="modal__title">История комментариев</h3>
        <button class="modal__close" onclick="closeCommentsModal()">×</button>
      </div>
      <div class="modal__body">
        <div id="commentsList" style="display: flex; flex-direction: column; gap: 16px;">
          <!-- Comments will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Completeness Modal -->
  <div class="modal" id="completenessModal">
    <div class="modal__content" style="max-width: 800px;">
      <div class="modal__header">
        <h3 class="modal__title">Комплектность</h3>
        <button class="modal__close" onclick="closeCompletenessModal()">×</button>
      </div>
      <div class="modal__body">
        <table class="table">
          <thead>
            <tr>
              <th>Детали</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody id="completenessTableBody">
            <!-- Will be populated by JS -->
          </tbody>
        </table>
        <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--g-color-line-generic);">
          <button type="button" class="btn btn--primary" onclick="saveCompleteness()" style="flex: 1;">Сохранить</button>
          <button type="button" class="btn btn--normal" onclick="closeCompletenessModal()" style="flex: 1;">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    let currentStep = 1;
    let photos = [];
    let signatureDrawn = false;
    let selectedCarPlate = null;

    function loadPreviousComment() {
      const carSelect = document.getElementById('carSelect');
      const selectedPlate = carSelect.value;
      selectedCarPlate = selectedPlate;
      const previousCommentSection = document.getElementById('previousCommentSection');
      const previousCommentText = document.getElementById('previousCommentText');
      
      if (!selectedPlate) {
        previousCommentSection.style.display = 'none';
        return;
      }

      // Find the most recent inspection/return for this car
      const inspections = mockData.inspections.filter(ins => ins.plate === selectedPlate && ins.type === 'Возврат');
      if (inspections.length > 0) {
        // Sort by date descending
        inspections.sort((a, b) => new Date(b.date) - new Date(a.date));
        const latestInspection = inspections[0];
        
        if (latestInspection.notes) {
          previousCommentText.textContent = latestInspection.notes;
          previousCommentSection.style.display = 'block';
        } else {
          previousCommentText.textContent = 'Нет комментариев';
          previousCommentSection.style.display = 'block';
        }
      } else {
        previousCommentText.textContent = 'Нет предыдущих комментариев';
        previousCommentSection.style.display = 'block';
      }
    }

    window.showCompletenessModal = function() {
      let carPlate = selectedCarPlate;
      
      if (!carPlate) {
        const carSelect = document.getElementById('carSelect');
        if (carSelect) {
          carPlate = carSelect.value;
        }
      }
      
      if (!carPlate) {
        alert('Сначала выберите автомобиль');
        return;
      }

      const car = mockData.cars.find(c => c.plate === carPlate);
      if (!car) {
        alert('Автомобиль не найден');
        return;
      }

      const numericCarId = car.id;
      let completeness = getCompletenessByCarId(numericCarId);
      const completenessTableBody = document.getElementById('completenessTableBody');
      
      if (!completenessTableBody) {
        alert('Ошибка: элемент таблицы не найден');
        return;
      }

      // If no completeness data exists, create default data
      if (completeness.length === 0) {
        const defaultItems = [
          'Шашка такси', 'Магнитола', 'Видеорегистратор', 'Зарядное устройство', 'Планшет для рекламы',
          'Детское кресло', 'Бустер', 'Зонт', 'Аптечка', 'Огнетушитель', 'Знак аварийной остановки',
          'Трос', 'Крюк', 'Ключ', 'Отвертка', 'Домкрат', 'Баллонный ключ', 'Запаска', 'ГБО',
          'СТС', 'ОСАГО', 'Диагностическая карта', 'Лицензия', 'Грязный салон', 'Запах табака',
          'Повреждение салонных ковриков', 'Повреждение обшивки дверей', 'Сломанные ручки', 'Требуется химчистка'
        ];
        completeness = defaultItems.map((item, index) => ({
          carId: numericCarId,
          item: item,
          status: index < 15 // First 15 items are present by default
        }));
        if (!mockData.completeness) {
          mockData.completeness = [];
        }
        mockData.completeness.push(...completeness);
        completeness = getCompletenessByCarId(numericCarId);
      }

      completenessTableBody.innerHTML = completeness.map((comp) => `
        <tr>
          <td>${comp.item}</td>
          <td>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
              <input type="checkbox" 
                     data-completeness-item="${comp.item}"
                     data-car-id="${numericCarId}"
                     ${comp.status ? 'checked' : ''} 
                     style="width: 18px; height: 18px; cursor: pointer;"
                     onchange="updateCompletenessStatus(this)">
              <span style="min-width: 100px;">${comp.status ? 'Есть' : 'Отсутствует'}</span>
            </label>
          </td>
        </tr>
      `).join('');

      const modal = document.getElementById('completenessModal');
      if (modal) {
        modal.classList.add('active');
      } else {
        alert('Ошибка: модальное окно не найдено');
      }
    };

    window.updateCompletenessStatus = function(checkbox) {
      const item = checkbox.dataset.completenessItem;
      const carId = parseInt(checkbox.dataset.carId);
      const span = checkbox.nextElementSibling;
      
      if (span) {
        span.textContent = checkbox.checked ? 'Есть' : 'Отсутствует';
      }
      
      // Update in mock data
      const completenessItem = mockData.completeness.find(c => c.carId === carId && c.item === item);
      if (completenessItem) {
        completenessItem.status = checkbox.checked;
      }
    };

    window.saveCompleteness = function() {
      closeCompletenessModal();
    };

    window.closeCompletenessModal = function() {
      const modal = document.getElementById('completenessModal');
      if (modal) {
        modal.classList.remove('active');
      }
    };

    window.showCommentsModal = function() {
      let carPlate = selectedCarPlate;
      
      if (!carPlate) {
        const carSelect = document.getElementById('carSelect');
        if (carSelect) {
          carPlate = carSelect.value;
        }
      }
      
      if (!carPlate) {
        alert('Сначала выберите автомобиль');
        return;
      }

      const commentsList = document.getElementById('commentsList');
      
      // Get all inspections with comments for this car
      const inspections = mockData.inspections.filter(ins => 
        ins.plate === carPlate && ins.notes
      );

      if (inspections.length === 0) {
        commentsList.innerHTML = '<div style="text-align: center; color: var(--g-color-text-secondary); padding: 24px;">Нет комментариев для данного автомобиля</div>';
      } else {
        // Sort by date descending
        inspections.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        commentsList.innerHTML = inspections.map(ins => {
          const date = new Date(ins.date);
          const formattedDate = date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          });
          const formattedTime = date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
          });
          
          return `
            <div style="padding: 16px; background: var(--g-color-base-generic); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: 500; margin-bottom: 4px;">${formattedDate}</div>
                  <div style="font-size: var(--g-font-size-sm); color: var(--g-color-text-secondary);">${formattedTime}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 500; margin-bottom: 4px;">${ins.mechanicName}</div>
                  <div style="font-size: var(--g-font-size-sm); color: var(--g-color-text-secondary);">Механик</div>
                </div>
              </div>
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--g-color-line-generic);">
                <div style="font-size: var(--g-font-size-sm); color: var(--g-color-text-secondary); margin-bottom: 4px;">Комментарий:</div>
                <div style="color: var(--g-color-text-primary);">${ins.notes}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      document.getElementById('commentsModal').classList.add('active');
    };

    window.closeCommentsModal = function() {
      document.getElementById('commentsModal').classList.remove('active');
    };

    function goToStep(step) {
      document.getElementById(`step${currentStep}Content`).style.display = 'none';
      document.getElementById(`step${currentStep}`).className = 'badge badge--neutral';
      
      currentStep = step;
      document.getElementById(`step${currentStep}Content`).style.display = 'block';
      document.getElementById(`step${currentStep}`).className = 'badge badge--info';
      
      if (step === 4) {
        initSignature();
      }
      if (step === 5) {
        checkComplete();
      }
    }

    function openCamera() {
      document.getElementById('cameraPhotoInput').click();
    }

    function openGallery() {
      document.getElementById('photoInput').click();
    }

    function handleCameraPhoto(event) {
      const files = Array.from(event.target.files || []);
      addPhotos(files);
      event.target.value = '';
    }

    function addPhotos(newFiles) {
      if (!newFiles.length) return;
      photos = photos.concat(newFiles);
      renderPhotoPreview();
      document.getElementById('step2Next').disabled = photos.length === 0;
    }

    function renderPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = photos.map((file) => `
        <div style="position: relative;">
          <img src="${URL.createObjectURL(file)}" style="width: 100%; height: 100px; object-fit: cover; border-radius: var(--g-border-radius-md);">
        </div>
      `).join('');
    }

    function handlePhotoUpload(event) {
      const files = Array.from(event.target.files || []);
      addPhotos(files);
      event.target.value = '';
    }


    function initSignature() {
      const canvas = document.getElementById('signatureCanvas');
      const ctx = canvas.getContext('2d');
      let isDrawing = false;

      // Keep drawing buffer aligned with visible canvas size.
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        startDrawing({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
      });
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        draw({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
      });
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      }

      function draw(e) {
        if (!isDrawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        signatureDrawn = true;
        document.getElementById('step4Next').disabled = false;
      }

      function stopDrawing() {
        isDrawing = false;
      }
    }

    function clearSignature() {
      const canvas = document.getElementById('signatureCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureDrawn = false;
      document.getElementById('step4Next').disabled = true;
    }

    function checkComplete() {
      const canComplete = photos.length > 0 && 
                         signatureDrawn;
      document.getElementById('completeBtn').disabled = !canComplete;
    }

    // Close modals on backdrop click
    document.getElementById('completenessModal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('completenessModal')) {
        closeCompletenessModal();
      }
    });

    document.getElementById('commentsModal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('commentsModal')) {
        closeCommentsModal();
      }
    });

    function completeIssue() {
      window.location.href = 'home.html?tab=issue';
    }
  </script>
</body>
</html>
